<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->

<!-- 参数管理手工映射SQL语句 -->
<!-- ASN表商品关联表 -->
<mapper namespace="pickingSku">

    <sql id="sql_where">
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
    </sql>


    <!-- 列表查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT a.*
        FROM w_picking_sku a
        <include refid="sql_where"/>
        ORDER by a.id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_picking_sku a
        <include refid="sql_where"/>
        ORDER by a.id
    </select>

    <!-- 对象查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT a.*
        FROM w_picking_sku a
        <include refid="sql_where"/>
    </select>

    <!-- 插入 -->
    <insert id="saveInfo" parameterType="map">
        insert into w_picking_sku (picking_id, allot_id,
        setting_id, facility_id, picking_num,no_package_num,
        receipt_id, create_time, creator,is_delete)
        values (#{picking_id}, #{allot_id},
        #{setting_id}, #{facility_id}, #{picking_num},#{no_package_num},
        #{receipt_id},now(), #{creator}, 'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 删除 -->
    <update id="deleteInfo" parameterType="map">
        UPDATE w_picking_sku set is_delete = 'Y' where id = #{id}
    </update>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="map">
        UPDATE w_picking_sku
        set
        <if test="null!=picking_no  and ''!= picking_no">
            picking_no = #{picking_no},
        </if>
        <if test="null!=picking_id  and ''!= picking_id">
            picking_id = #{picking_id},
        </if>
        <if test="null!=allot_id  and ''!= allot_id">
            allot_id = #{allot_id},
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            setting_id = #{setting_id},
        </if>
        <if test="null!=facility_id  and ''!= facility_id">
            facility_id = #{facility_id},
        </if>
        <if test="null!=picking_num  and ''!= picking_num">
            picking_num = #{picking_num},
        </if>
        <if test="null!=add_picking_num  and ''!= add_picking_num">
            no_package_num = no_package_num+#{add_picking_num},
        </if>
        <if test="null!=sub_picking_num  and ''!= sub_picking_num">
            no_package_num = no_package_num-#{sub_picking_num},
        </if>
        <if test="null!=receipt_id  and ''!= receipt_id">
            receipt_id = #{receipt_id},
        </if>
        <if test="null!=updator  and ''!= updator">
            a.updator = #{updator}, ,
        </if>
        update_time = now()
        where id = #{id}
    </update>


    <!-- 查询未打包完成信息 -->
    <select id="queryNoPackageInfo" parameterType="map" resultType="dto">
        SELECT
        a.id,
        b.id as ids,
        b.picking_no,
        d.number as product_no,
        d.`name`,
        d. LEVEL as spec,
        e.number,
        a.picking_num,
        a.no_package_num
        FROM
        w_picking_sku AS a
        LEFT JOIN w_picking AS b ON (a.picking_id = b.id)
        LEFT JOIN w_batch_allot AS c ON (a.allot_id = c.id)
        LEFT JOIN w_sku AS d ON (d.id = c.sku_id)
        LEFT JOIN w_warehouse_facility_setting AS e ON (e.id = a.facility_id)
        where a.no_package_num!=0
    </select>

    <!-- 查询未打包完成信息 -->
    <select id="queryNoPackageInfoCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_picking_sku AS a
        LEFT JOIN w_picking AS b ON (a.picking_id = b.id)
        LEFT JOIN w_batch_allot AS c ON (a.allot_id = c.id)
        LEFT JOIN w_sku AS d ON (d.id = c.sku_id)
        LEFT JOIN w_warehouse_facility_setting AS e ON (e.id = a.facility_id)
        where a.no_package_num!=0
    </select>

    <!-- 查询已打包完成信息 -->
    <select id="queryPackageInfo" parameterType="map" resultType="dto">
        SELECT
        s.id,
        s.picking_sku_id as ids,
        b.picking_no,
        d.number as product_no,
        s.picking_num,
        d.`name`
        FROM
        w_package_pick AS s
        LEFT JOIN w_picking_sku AS a on(s.picking_id=a.picking_id and s.picking_sku_id=a.id)
        LEFT JOIN w_picking AS b ON (a.picking_id = b.id)
        LEFT JOIN w_batch_allot AS c ON (a.allot_id = c.id)
        LEFT JOIN w_sku AS d ON (d.id = c.sku_id)
        where s.package_id=#{package_id}
    </select>

    <!-- 查询已打包完成信息 -->
    <select id="queryPackageInfoCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_package_pick AS s
        LEFT JOIN w_picking_sku AS a on(s.picking_id=a.picking_id and s.picking_sku_id=a.id)
        LEFT JOIN w_picking AS b ON (a.picking_id = b.id)
        LEFT JOIN w_batch_allot AS c ON (a.allot_id = c.id)
        LEFT JOIN w_sku AS d ON (d.id = c.sku_id)
        where s.package_id=#{package_id}
    </select>
</mapper>
