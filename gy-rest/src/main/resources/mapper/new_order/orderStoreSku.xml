<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 库存 -->
<mapper namespace="norderStoreSku">
    <sql id="sql_where">
        <if test="null!=deptid  and ''!= deptid">
            and a.deptid = #{deptid}
        </if>
        <if test="null!=provider_id  and ''!= provider_id">
            and a.provider_id = #{provider_id}
        </if>
        <if test="null!=customer_id  and ''!= customer_id">
            and a.provider_id = #{customer_id}
        </if>
        <if test="null!=deptid  and ''!= deptid">
            and a.deptid = #{deptid}
        </if>
        <if test="null!=in_batch_number  and ''!= in_batch_number">
            and a.in_batch_number = #{in_batch_number}
        </if>
        <if test="null!=store_sku_number  and ''!= store_sku_number">
            and a.store_sku_number = #{store_sku_number}
        </if>
        <if test="null!=status">
            and a.status = #{status}
        </if>
        <if test="null!=buy_sku_id  and ''!= buy_sku_id">
            and a.buy_sku_id = #{buy_sku_id}
        </if>
        <if test="null!=buy_checked_id  and ''!= buy_checked_id">
            and a.buy_checked_id = #{buy_checked_id}
        </if>
        <if test="null!=sku_name  and ''!= sku_name">
            and obc.sku_name LIKE concat('%',#{sku_name},'%')
        </if>
        <if test="null!=client_name  and ''!= client_name">
            and cu.client_name LIKE concat('%',#{client_name},'%')
        </if>
        <if test="null!=sku_number  and ''!= sku_number">
            and obc.sku_number LIKE concat('%',#{sku_number},'%')
        </if>
        <if test="null!=sku_level  and ''!= sku_level">
            and obc.sku_level LIKE concat('%',#{sku_level},'%')
        </if>
        <if test="null!=bill  and ''!= bill">
            and obc.bill LIKE concat('%',#{bill},'%')
        </if>
        <if test="null!=remark  and ''!= remark">
            and obc.remark LIKE concat('%',#{remark},'%')
        </if>
        <if test="null!=sku_type_number  and ''!= sku_type_number">
            and obc.sku_type_number LIKE concat('%',#{sku_type_number},'%')
        </if>
        <if test="null!=sku_type_text  and ''!= sku_type_text">
            and obc.sku_type_text LIKE concat('%',#{sku_type_text},'%')
        </if>
        <if test="null!=unit_weight  and ''!= unit_weight">
            and obc.unit_weight = #{unit_weight}
        </if>
        <if test="null!=unit_volume  and ''!= unit_volume">
            and obc.unit_volume = #{unit_volume}
        </if>

        <if test="null!=set_name  and ''!= set_name">
            and wss.name LIKE concat('%',#{set_name},'%')
        </if>
        <if test="null!=set_number  and ''!= set_number">
            and wss.number LIKE concat('%',#{set_number},'%')
        </if>
        <if test="null!=tray_name  and ''!= tray_name">
            and t.name LIKE concat('%',#{tray_name},'%')
        </if>
        <if test="null!=tray_number  and ''!= tray_number">
            and t.number LIKE concat('%',#{tray_number},'%')
        </if>

        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>

        <if test="null!=exist_stock  and ''!= exist_stock">
            and a.exist_stock >= #{exist_stock}
        </if>
        <if test="null!=min_create_time  and ''!= min_create_time">
            and a.create_time >= #{min_create_time}
        </if>
        <if test="null!=max_create_time  and ''!= max_create_time">
            and a.create_time &lt;= #{max_create_time}
        </if>
        <if test="null!=min_roduction_date  and ''!= min_roduction_date">
            and obc.roduction_date >= #{min_roduction_date}
        </if>
        <if test="null!=max_roduction_date  and ''!= max_roduction_date">
            and obc.roduction_date &lt;= #{max_roduction_date}
        </if>

        <if test="null!=min_expiration_date  and ''!= min_expiration_date">
            and obc.expiration_date >= #{min_roduction_date}
        </if>
        <if test="null!=max_expiration_date  and ''!= max_expiration_date">
            and obc.expiration_date &lt;= #{max_expiration_date}
        </if>


        <if test="null!=creator_name  and ''!= creator_name">
            and su.username LIKE concat('%',#{creator_name},'%')
        </if>
    </sql>

    <select id="queryList" parameterType="map" resultType="dto">
        SELECT
        a.*,
        cu.client_name,
        cu.warningday,
        obk.shelflife,
        obc.sku_name,
        obc.sku_number,
        obc.sku_level,
        obc.roduction_date,
        obc.expiration_date,
        obc.sku_type_number,
        obc.sku_type_text,
        obc.bill,
        obc.bill_photo,
        obc.remark,
        obc.unit_weight,
        obc.unit_volume,
        wss.`name` as set_name,
        wss.number as set_number,
        t.`name` as tray_name,
        t.number as tray_number,
        su.username as creator_name,
        to_days(ADDDATE(obc.roduction_date,INTERVAL CEILING (obk.shelflife * cu.warningday_num) DAY)) - to_days(now())
        as warning_days,
        to_days(obc.expiration_date) - to_days(now()) as is_expired_days,
        cu.manager_email,
        (SELECT count(id) FROM w_mail WHERE in_batch_number = a.in_batch_number and `status` = 0 and
        (to_days(create_time) - to_days(now()) = 0) ) as sendemail
        FROM
        (
        SELECT
        deptid,
        buy_sku_id,
        buy_checked_id,
        sku_id,
        tray_id,
        provider_id,
        setting_id,
        in_batch_number,
        SUM(IF(status = 0, stock, 0)) AS exist_stock,
        SUM(IF(status = 1, stock, 0)) AS frozen_stock,
        SUM(IF(status = 2, stock, 0)) AS out_stock,
        SUM(stock) AS total_stock,
        creator,
        create_time
        FROM
        w_order_store_sku
        WHERE is_delete = 'N'
        GROUP BY
        in_batch_number,
        sku_id
        HAVING exist_stock > 0
        ) a
        LEFT JOIN w_customer cu on cu.id = a.provider_id
        LEFT JOIN w_order_buy_checked obc on a.buy_checked_id = obc.id
        LEFT JOIN w_order_buy_sku obk on obk.id = a.buy_sku_id
        LEFT JOIN w_warehouse_site_setting wss on wss.id = a.setting_id
        LEFT JOIN w_tray t on a.tray_id = t.id
        LEFT JOIN sys_user su on a.creator = su.id
        WHERE 1 = 1
        <include refid="sql_where"/>
        HAVING
        cu.client_name is not NULL
        <if test="null!=min_warning_days  and ''!= min_warning_days">
            and warning_days >= #{min_warning_days}
        </if>
        <if test="null!=max_warning_days  and ''!= max_warning_days">
            and warning_days &lt;= #{max_warning_days}
        </if>
        <if test="null!=min_is_expired_days  and ''!= min_is_expired_days">
            and is_expired_days >= #{min_is_expired_days}
        </if>
        <if test="null!=max_is_expired_days  and ''!= max_is_expired_days">
            and is_expired_days &lt;= #{max_is_expired_days}
        </if>
        <if test="null!=sendemail  and ''!= sendemail">
            and sendemail = 0
        </if>


        ORDER BY a.buy_checked_id DESC
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM (
        SELECT
        cu.client_name,
        to_days(ADDDATE(obc.roduction_date,INTERVAL CEILING (obk.shelflife * cu.warningday_num) DAY)) - to_days(now())
        as warning_days,
        to_days(obc.expiration_date) - to_days(now()) as is_expired_days,
        (SELECT count(id) FROM w_mail WHERE in_batch_number = a.in_batch_number and `status` = 0 and
        (to_days(create_time) - to_days(now()) = 0) ) as sendemail
        FROM
        (
        SELECT
        deptid,
        buy_sku_id,
        buy_checked_id,
        sku_id,
        tray_id,
        provider_id,
        setting_id,
        in_batch_number,
        SUM(IF(STATUS = 0, stock, 0)) AS exist_stock,
        SUM(IF(STATUS = 1, stock, 0)) AS frozen_stock,
        SUM(IF(STATUS = 2, stock, 0)) AS out_stock,
        SUM(stock) AS total_stock,
        creator,
        create_time
        FROM
        w_order_store_sku
        WHERE is_delete = 'N'
        GROUP BY
        in_batch_number,
        sku_id
        HAVING exist_stock > 0
        ) a
        LEFT JOIN w_customer cu on cu.id = a.provider_id
        LEFT JOIN w_order_buy_checked obc on a.buy_checked_id = obc.id
        LEFT JOIN w_order_buy_sku obk on obk.id = a.buy_sku_id
        LEFT JOIN w_warehouse_site_setting wss on wss.id = a.setting_id
        LEFT JOIN w_tray t on a.tray_id = t.id
        LEFT JOIN sys_user su on a.creator = su.id
        WHERE
        1 = 1
        <include refid="sql_where"/>

        HAVING
        cu.client_name is not NULL
        <if test="null!=min_warning_days  and ''!= min_warning_days">
            and warning_days >= #{min_warning_days}
        </if>
        <if test="null!=max_warning_days  and ''!= max_warning_days">
            and warning_days &lt;= #{max_warning_days}
        </if>
        <if test="null!=min_is_expired_days  and ''!= min_is_expired_days">
            and is_expired_days >= #{min_is_expired_days}
        </if>
        <if test="null!=max_is_expired_days  and ''!= max_is_expired_days">
            and is_expired_days &lt;= #{max_is_expired_days}
        </if>
        <if test="null!=sendemail  and ''!= sendemail">
            and sendemail = 0
        </if>


        ) as a
    </select>

    <!-- 插入 -->
    <insert id="saveInfo" parameterType="map">
        insert into w_order_store_sku (in_batch_number,buy_sku_id,buy_checked_id,tray_id,deptid, order_type,
        sku_id, stock,store_sku_number,
        provider_id, setting_id, status,
        create_time, creator, is_delete)
        values (#{in_batch_number},#{buy_sku_id},#{buy_checked_id},#{tray_id},#{deptid}, '2', #{sku_id},
        #{stock},#{store_sku_number},
        #{provider_id}, #{setting_id}, #{status},
        now(), #{creator}, 'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 删除 -->
    <update id="deleteInfo" parameterType="map">
        UPDATE w_order_store_sku set is_delete = 'Y' where id = #{id}
    </update>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="map">
        UPDATE w_order_store_sku a
        set
        <if test="null!=deptid  and ''!= deptid">
            a.deptid = #{deptid},
        </if>
        <if test="null!=in_batch_number  and ''!= in_batch_number">
            a.in_batch_number = #{in_batch_number},
        </if>
        <if test="null!=sku_id  and ''!= sku_id">
            a.sku_id = #{sku_id},
        </if>
        <if test="null!=stock  and ''!= stock">
            a.stock = #{stock},
        </if>
        <if test="null!=addstock  and ''!= addstock">
            a.lock_stock = a.lock_stock+#{addstock},
        </if>
        <if test="null!=substock  and ''!= substock">
            a.lock_stock = a.lock_stock-#{substock},
        </if>
        <if test="null!=provider_id  and ''!= provider_id">
            a.provider_id = #{provider_id},
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            a.setting_id = #{setting_id},
        </if>
        <if test="null!=status">
            a.status = #{status},
        </if>
        <if test="null!=overcharge  and ''!= overcharge">
            a.overcharge = #{overcharge},
        </if>
        <if test="null!=owing  and ''!= owing">
            a.owing = #{owing},
        </if>
        <if test="null!=productstatus  and ''!= productstatus">
            a.productstatus = #{productstatus},
        </if>
        <if test="null!=updator  and ''!= updator">
            a.updator = #{updator},
        </if>
        <if test="null!=buy_checked_id  and ''!= buy_checked_id">
            a.buy_checked_id = #{buy_checked_id},
        </if>
        <if test="null!=buy_sku_id  and ''!= buy_sku_id">
            a.buy_sku_id = #{buy_sku_id},
        </if>
        update_time = now()
        where a.id = #{id}
    </update>

    <!-- 对象查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT
        a.*
        FROM
        w_order_store_sku a
        <include refid="sql_where"/>
    </select>

    <!-- 修改 -->
    <update id="updateStockInfo" parameterType="map">
        UPDATE w_order_store_sku a
        set
        <if test="null!=deptid  and ''!= deptid">
            a.deptid = #{deptid},
        </if>
        <if test="null!=sku_id  and ''!= sku_id">
            a.sku_id = #{sku_id},
        </if>
        <if test="null!=stock  and ''!= stock">
            a.stock = #{stock},
        </if>
        <if test="null!=addstock  and ''!= addstock">
            a.lock_stock = a.lock_stock+#{addstock},
        </if>
        <if test="null!=substock  and ''!= substock">
            a.lock_stock = a.lock_stock-#{substock},
        </if>
        <if test="null!=provider_id  and ''!= provider_id">
            a.provider_id = #{provider_id},
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            a.setting_id = #{setting_id},
        </if>
        <if test="null!=status">
            a.status = #{status},
        </if>
        <if test="null!=updator  and ''!= updator">
            a.updator = #{updator},
        </if>
        <if test="null!=buy_checked_id  and ''!= buy_checked_id">
            a.buy_checked_id = #{buy_checked_id},
        </if>
        <if test="null!=buy_sku_id  and ''!= buy_sku_id">
            a.buy_sku_id = #{buy_sku_id},
        </if>
        update_time = now()
        where a.sku_id = #{sku_id}
    </update>

    <select id="querySettingSkus" parameterType="map" resultType="dto">
        SELECT
        ifnull(sum(a.stock), 0) AS stock,
        a.buy_sku_id,
        a.id,
        b. name,
        b. level,
        oses.export_stock_num,
        b.roduction_date
        FROM
        w_order_store_sku AS a
        LEFT JOIN w_order_buy_sku AS b ON (a.buy_sku_id = b.id)
        LEFT JOIN w_order_sale_export_sku oses ON oses.buy_sku_id = a.buy_sku_id
        <if test="null!=sale_id  and ''!= sale_id">
            and oses.sale_id = #{sale_id}
        </if>
        LEFT JOIN w_customer cus ON a.provider_id = cus.id
        WHERE
        stock > 0
        AND a. STATUS = 0
        AND to_days(b.expiration_date) - to_days(now()) >= 0
        AND a.provider_id = #{customer_id}

        GROUP BY
        a.sku_id,
        b.roduction_date
    </select>


    <!-- 修改 -->
    <update id="deleteStock" parameterType="map">
        UPDATE w_order_store_sku
        set
        is_delete = "Y",
        update_time = now(),
        updator = #{updator}
        where in_batch_number = #{in_batch_number}
    </update>
</mapper>
