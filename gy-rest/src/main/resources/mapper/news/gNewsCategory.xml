<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="gNewsCategory">


    <!-- 分类类型初始化-->
    <select id="queryTypeList" parameterType="map" resultType="dto">
        SELECT a.id as refId,a.name
        FROM g_news_category a
        WHERE 1=1
        and a.delete_flag = 0
        and a.level!=2
        <if test="null!=level">
            and a.level=#{level}
        </if>

    </select>

    <!-- 分类列表初始化-->
    <select id="queryCategoryList" parameterType="map" resultType="dto">
        SELECT a.*
        FROM g_news_category a
        WHERE 1=1
        and a.delete_flag = 0

        <if test="null!=level">
            and a.level=#{level}
        </if>
        <if test="null!=categoryId">
            and a.id=#{categoryId}
        </if>
        <if test="null!=name">
            and a.name like  CONCAT('%',#{name},'%')
        </if>
        <if test="null!=status">
            and a.status=#{status}
        </if>
        <if test="null!=platform">
            and a.platform=#{platform}
        </if>
        order by a.sort
    </select>

    <!-- 分类列表初始化-->
    <select id="queryCategoryList1" parameterType="map" resultType="dto">
            SELECT
                a.*,
              if(COUNT(gna.id)>0,0,1) as isArticle
            FROM
                g_news_category a
            LEFT JOIN g_news_article gna on gna.category_id=a.id and gna.delete_flag=0
            WHERE
                1 = 1
            AND a.delete_flag = 0
            and a.ref_id=#{refId}
            GROUP BY a.id
            ORDER BY
                a.sort
    </select>
    <!-- 新增分类 -->
    <insert id="saveInfo" parameterType="dto">
        insert into g_news_category
        (code,name,platform,
        sort, level,ref_id,status,
        `creator`,
        `updator`,
        create_time,
        update_time
        )
        values (111,#{name},#{platform},
        #{sort},#{level},#{refId},
        #{status},
        <if test="null!=creator  and ''!= creator">
            #{creator},
        </if>
        <if test="null!=updator  and ''!= updator">
            #{updator},
        </if>
        now(),
        now()
        )
    </insert>

    <!--启用禁用-->
    <update id="updateSecondCateGoryStatus" parameterType="dto">
        update g_news_category
        set
        <if test="status!=null  and ''!= status">
            status = #{status},
        </if>
        <if test="updator!=null  and ''!= updator">
            updator = #{updator},
        </if>
        update_time = now()
        where
        ref_id = #{refId}
    </update>


    <!--编辑修改-->
    <update id="updateInfo" parameterType="dto">
        update g_news_category
        set
        <if test="name!=null  and ''!= name">
            name = #{name},
        </if>
        <if test="platform!=null  and ''!= platform">
            platform = #{platform},
        </if>
        <if test="sort!=null  and ''!= sort">
            sort = #{sort},
        </if>
        <if test="status!=null  and ''!= status">
            status = #{status},
        </if>
        <if test="refId!=null  and ''!= refId">
            ref_id = #{refId},
        </if>
        <if test="updator!=null  and ''!= updator">
            updator = #{updator},
        </if>
        update_time = now()
        where
        id = #{id}
    </update>


    <!--页面删除-->
    <update id="deleteInfo" parameterType="dto">
        update g_news_category set
        delete_flag =1
        where id=#{id}
    </update>


    <!-- 查询是否有从属分类 -->
    <select id="querySecondListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM g_news_category a
        WHERE
        ref_id=#{refId}
      and a.delete_flag=0
    </select>


    <!-- 查询是否有文章 -->
    <select id="querySecondArticleCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM g_news_article a
        WHERE
        category_id=#{refId}
        and a.delete_flag=0
    </select>


    <!-- 新增子类 -->
    <insert id="saveChildrenCategory" parameterType="dto">
        insert into g_news_category
        (code,name,platform,
        sort, level,ref_id,status,
        `creator`,
        `updator`,
        create_time,
        update_time
        )
        values (111,#{name},#{platform},
        #{sort},#{level},#{refId},
        #{status},
        <if test="null!=creator  and ''!= creator">
            #{creator},
        </if>
        <if test="null!=updator  and ''!= updator">
            #{updator},
        </if>
        now(),
        now()
        )
    </insert>
</mapper>
