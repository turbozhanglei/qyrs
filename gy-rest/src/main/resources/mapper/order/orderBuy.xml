<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="orderBuy">


    <sql id="sql_where">
        <if test="null!=number  and ''!= number">
            and a.number LIKE concat('%',#{number},'%')
        </if>
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=status">
            and a.status = #{status}
        </if>
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
    </sql>

    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT a.*,s.val as ordertype,c.`name` as ownername,c1.`name` as providername,s1.val as priorityval,
        (select group_concat(sk.sku_id) from w_order_asn_sku as sk where sk.order_id=a.id) as sku_id
        FROM w_order_asn a
        LEFT JOIN w_cmn_provider c on a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 on a.provider_id = c1.id
        LEFT JOIN sys_config s on a.order_type = s.id
        LEFT JOIN sys_config s1 on a.priority = s1.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER BY id
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_asn a
        LEFT JOIN w_cmn_provider c on a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 on a.provider_id = c1.id
        LEFT JOIN sys_config s on a.order_type = s.id
        LEFT JOIN sys_config s1 on a.priority = s1.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
    </select>

    <!-- 查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT a.*,s.val as ordertype,c.`name` as ownername,c1.`name` as providername,s1.val as priorityval
        FROM w_order_asn a
        LEFT JOIN w_cmn_provider c on a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 on a.provider_id = c1.id
        LEFT JOIN sys_config s on a.order_type = s.id
        LEFT JOIN sys_config s1 on a.priority = s1.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
        limit 0,1
    </select>


    <!-- 插入 -->
    <insert id="saveInfo" parameterType="dto">
        insert into w_order_asn (order_no, order_type,
        provider_id, provider_carrier_id, provider_owner_id,
        carrier, priority, start_time,
        end_time, purchase, receive,
        remark, status, create_time,
        creator, is_delete)
        values (#{order_no}, #{order_type},
        #{provider_id}, #{provider_carrier_id}, #{provider_owner_id},
        #{carrier}, #{priority}, #{start_time},
        #{end_time}, #{purchase}, #{receive},
        #{remark}, '715', now(), #{creator}, 'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="dto">
        update w_order_asn
        set
        <if test="null!=order_no  and ''!= order_no">
            order_no = #{order_no},
        </if>
        <if test="null!=provider_id  and ''!= provider_id">
            provider_id = #{provider_id},
        </if>
        <if test="null!=provider_carrier_id  and ''!= provider_carrier_id">
            provider_carrier_id = #{provider_carrier_id},
        </if>
        <if test="null!=provider_owner_id  and ''!= provider_owner_id">
            provider_owner_id = #{provider_owner_id},
        </if>
        <if test="null!=priority  and ''!= priority">
            priority = #{priority},
        </if>
        <if test="null!=start_time  and ''!= start_time">
            start_time = #{start_time},
        </if>
        <if test="null!=end_time  and ''!= end_time">
            end_time = #{end_time},
        </if>
        <if test="null!=purchase  and ''!= purchase">
            purchase = #{purchase},
        </if>
        <if test="null!=receive  and ''!= receive">
            receive = #{receive},
        </if>
        <if test="null!=remark  and ''!= remark">
            remark = #{remark},
        </if>
        <if test="null!=status">
            status = #{status},
        </if>
        <if test="null!=updator  and ''!= updator">
            updator = #{updator},
        </if>
        update_time = now()
        where id = #{id}
    </update>

    <!-- 删除 -->
    <delete id="deleteInfo" parameterType="map">
        UPDATE w_order_asn set is_delete = 'Y' WHERE id = #{id}
    </delete>

    <!--订单质检关联表 插入 -->
    <insert id="saveQualityInfo" parameterType="dto">
        insert into w_order_quality (order_id,ispass,remark, create_time,
        creator, is_delete)
        values (#{order_id},#{ispass},#{remark},now(),#{creator},'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 查询 -->
    <select id="queryListForUser" parameterType="map" resultType="dto">
        SELECT a.*
        FROM order_buy_user a
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=user_id  and ''!= user_id">
            and a.user_id = #{user_id}
        </if>
        ORDER BY id
    </select>


</mapper>
