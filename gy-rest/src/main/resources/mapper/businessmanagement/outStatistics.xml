<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="outStatistics">


    <sql id="sql_where">

        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
        <if test="null!=food_add_type  and ''!= food_add_type">
            and st.food_add_type =#{food_add_type}
        </if>
        <if test="null!=sku_type_text  and ''!= sku_type_text">
            and st.text=#{sku_type_text}
        </if>
        <if test="null!=sku_name  and ''!= sku_name">
            and obs.`name` LIKE concat('%',#{sku_name},'%')
        </if>
        <if test="null!=sku_number  and ''!= sku_number">
            and obs.number LIKE concat('%',#{sku_number},'%')
        </if>
        <if test="null!=client_name  and ''!= client_name">
            and c.client_name LIKE concat('%',#{client_name},'%')
        </if>

    </sql>

    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT a.*,c.client_name,os.* ,obs.`name` as proname,obs.number,sk.`level`,SUM(a.out_stock_num) as arrival_nums,
        SUM(a.out_stock_num) * sk.unit_weight as pro_weight,sk.unit_volume,sk.unit_weight,st.food_add_type,st.text
        FROM
        w_order_sale_sku a
        LEFT JOIN w_order_sale os on a.sale_id =os.id
        LEFT JOIN w_order_buy_sku obs on a.buy_sku_id=obs.id
        LEFT JOIN w_customer c on os.customer_id = c.id
        LEFT JOIN w_sku sk on obs.sku_id = sk.id and sk.is_delete='N'
        LEFT JOIN w_sku_type st on sk.type_id = st.id
        WHERE a.is_delete ='N'
        AND a.status = 50
        <include refid="sql_where"/>
        GROUP BY a.sku_id
        ORDER BY a.id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>


    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT
        count(1) AS total
        FROM
        (
        SELECT
        a.*
        FROM
        w_order_sale_sku a
        LEFT JOIN w_order_sale os on a.sale_id =os.id
        LEFT JOIN w_order_buy_sku obs on a.buy_sku_id=obs.id
        LEFT JOIN w_customer c on os.customer_id = c.id
        LEFT JOIN w_sku sk on obs.sku_id = sk.id and sk.is_delete='N'
        WHERE a.is_delete ='N'
        AND a.status = 50
        GROUP BY a.sku_id
        ) AS a
        <include refid="sql_where"/>
    </select>


    <!-- 查询 -->
    <select id="queryDetail" parameterType="map" resultType="dto">
        SELECT
        a.*, c.client_name,
        a.create_time,
        os.*, obs.`name` AS proname,
        obs.roduction_date,
        obs.number,
        obs.`level`,
        obs.expiration_date,
        storage_time,
        sk.unit_volume,
        sk.unit_weight,
        st.food_add_type,
        st.text,
        wse.number AS wsname,
        sus.username
        FROM
        w_order_sale_sku a
        LEFT JOIN w_order_sale os ON a.sale_id = os.id
        LEFT JOIN w_order_buy_sku obs ON a.buy_sku_id = obs.id
        LEFT JOIN w_customer c ON os.customer_id = c.id
        LEFT JOIN w_sku sk ON obs.sku_id = sk.id
        LEFT JOIN w_sku_type st ON sk.type_id = st.id
        LEFT JOIN sys_user sus ON a.creator = sus.id
        LEFT JOIN w_order_store_sku oss ON a.store_id = oss.id
        LEFT JOIN w_warehouse_site_setting wse ON oss.setting_id = wse.id
        WHERE
        a.is_delete = 'N'
        AND a. STATUS = 50
        AND obs.sku_id = #{sku_id}

        <include refid="sql_where"/>
        ORDER BY a.id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>


    <!-- 查询 -->
    <select id="queryDetailCount" parameterType="map" resultType="dto">
        SELECT
        count(1) AS total
        FROM
        w_order_sale_sku a
        LEFT JOIN w_order_sale os ON a.sale_id = os.id
        LEFT JOIN w_order_buy_sku obs ON a.buy_sku_id = obs.id
        LEFT JOIN w_customer c ON os.customer_id = c.id
        LEFT JOIN w_sku sk ON obs.sku_id = sk.id
        LEFT JOIN w_sku_type st ON sk.type_id = st.id
        LEFT JOIN sys_user sus on a.creator=sus.id
        WHERE
        a.is_delete = 'N'
        AND a. STATUS = 50
        AND obs.sku_id = #{sku_id}
        <include refid="sql_where"/>
        ORDER BY a.id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>


</mapper>
