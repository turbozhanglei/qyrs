<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="wOrderNoSaleSku">


    <sql id="sql_where">
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
        <if test="null!=_id  and ''!= _id">
            and a.id = #{_id}
        </if>
        <if test="null!=tray_id  and ''!= tray_id">
            and a.tray_id = #{tray_id}
        </if>
        <if test="null!=sku_name  and ''!= sku_name">
            and a.sku_name like concat('%',#{sku_name},'%')
        </if>
        <if test="null!=sku_level  and ''!= sku_level">
            and a.sku_level like concat('%',#{sku_level},'%')
        </if>
        <if test="null!=sku_number  and ''!= sku_number">
            and a.sku_number like concat('%',#{sku_number},'%')
        </if>
        <if test="null!=_sku_number  and ''!= _sku_number">
            and a.sku_number = #{_sku_number}
        </if>
        <if test="null!=sku_id  and ''!= sku_id">
            and a.sku_id = #{sku_id}
        </if>
        <if test="null!=sku_type_number  and ''!= sku_type_number">
            and a.sku_type_number like concat('%',#{sku_type_number},'%')
        </if>
        <if test="null!=sku_type_text  and ''!= sku_type_text">
            and a.sku_type_text like concat('%',#{sku_type_text},'%')
        </if>

        <if test="null!=min_instock_time  and ''!= min_instock_time">
            and a.instock_time >= #{min_instock_time}
        </if>
        <if test="null!=max_start_time  and ''!= max_start_time">
            and a.instock_time &lt;= #{max_instock_time}
        </if>

        <if test="null!=savearea  and ''!= savearea">
            and a.savearea = #{savearea}
        </if>
        <if test="null!=num  and ''!= num">
            and a.num = #{num}
        </if>
        <if test="null!=isexpired  and ''!= isexpired">
            and a.isexpired = #{isexpired}
        </if>
        <if test="null!=bill  and ''!= bill">
            and a.bill like concat('%',#{bill},'%')
        </if>
        <if test="null!=number  and ''!= number">
            and a.number like concat('%',#{number},'%')
        </if>
        <if test="null!=bill_photo  and ''!= bill_photo">
            and a.bill_photo = #{bill_photo}
        </if>
        <if test="null!=customer_id  and ''!= customer_id">
            and a.customer_id = #{customer_id}
        </if>
        <if test="null!=client_name  and ''!= client_name">
            and a.client_name = #{client_name}
        </if>
        <if test="null!=cargo_nature  and ''!= cargo_nature">
            and a.cargo_nature = #{cargo_nature}
        </if>
        <if test="null!=sku_out_why  and ''!= sku_out_why">
            and a.sku_out_why like concat('%',#{sku_out_why},'%')
        </if>
        <if test="null!=order_get  and ''!= order_get">
            and a.order_get = #{order_get}
        </if>
        <if test="null!=_number  and ''!= _number">
            and a.number = #{_number}
        </if>

        <if test="null!=remark  and ''!= remark">
            and a.remark like concat('%',#{remark},'%')
        </if>
        <if test="null!=create_time  and ''!= create_time">
            and a.create_time = #{create_time}
        </if>
        <if test="null!=creator  and ''!= creator">
            and a.creator = #{creator}
        </if>
        <if test="null!=update_time  and ''!= update_time">
            and a.update_time = #{update_time}
        </if>
        <if test="null!=customer_id  and ''!= customer_id">
            and a.customer_id = #{customer_id}
        </if>
        <if test="null!=in_batch_number  and ''!= in_batch_number">
            and a.in_batch_number = #{in_batch_number}
        </if>
    </sql>

    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT
        a.*,b.number as setting_num,if(to_days(a.expiration_date) - to_days(now()) >= 0,'否','是') as is_expired
        FROM
        w_order_no_sale_sku a
        LEFT JOIN w_warehouse_site_setting b on a.setting_id=b.id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER BY a.id desc
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 对象添加 -->
    <insert id="saveInfo" parameterType="map">
        INSERT INTO `w_order_no_sale_sku` (
        `number`,
        `tray_id`,
        `tray_number`,
        `setting_id`,
        `sku_name`,
        `sku_level`,
        `sku_number`,
        `roduction_date`,
        `expiration_date`,
        `sku_type_number`,
        `sku_type_text`,
        `instock_time`,
        `num`,
        `isexpired`,
        `bill`,
        `bill_photo`,
        `customer_id`,
        `client_name`,
        `cargo_nature`,
        `sku_out_why`,
        `out_warehouse_img`,
        `remark`,
        `creator`,
        `create_time`,
        `is_delete`,
        in_batch_number
        )
        VALUES
        (
        #{number}, #{tray_id}, #{tray_number}, #{setting_id}, #{sku_name}, #{sku_level},
        #{sku_number}, #{roduction_date}, #{expiration_date}, #{sku_type_number}, #{sku_type_text}, #{instock_time},
        #{num},
        #{isexpired},
        #{bill}, #{bill_photo}, #{customer_id}, #{client_name}, #{cargo_nature}, #{sku_out_why}, #{out_warehouse_img},
        #{remark}, #{creator},
        NOW(), 'N',#{in_batch_number})
        <selectKey resultType="java.lang.Long" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 对象修改 -->
    <update id="updateInfo" parameterType="dto">
        UPDATE `w_order_no_sale_sku`
        SET
        <if test="null!=tray_id  and ''!= tray_id">tray_id=#{tray_id} ,</if>
        <if test="null!=product_name  and ''!= product_name">product_name=#{product_name} ,</if>
        <if test="null!=sku_level  and ''!= sku_level">sku_level=#{sku_level} ,</if>
        <if test="null!=sku_id  and ''!= sku_id">sku_id=#{sku_id} ,</if>
        <if test="null!=sku_type_number  and ''!= sku_type_number">sku_type_number=#{sku_type_number} ,</if>
        <if test="null!=sku_type_text  and ''!= sku_type_text">sku_type_text=#{sku_type_text} ,</if>
        <if test="null!=instock_time  and ''!= instock_time">instock_time=#{instock_time} ,</if>
        <if test="null!=savearea  and ''!= savearea">savearea=#{savearea} ,</if>
        <if test="null!=num  and ''!= num">num=#{num} ,</if>
        <if test="null!=isexpired  and ''!= isexpired">isexpired=#{isexpired} ,</if>
        <if test="null!=bill  and ''!= bill">bill=#{bill} ,</if>
        <if test="null!=bill_photo  and ''!= bill_photo">bill_photo=#{bill_photo} ,</if>
        <if test="null!=customer_id  and ''!= customer_id">customer_id=#{customer_id} ,</if>
        <if test="null!=client_name  and ''!= client_name">client_name=#{client_name} ,</if>
        <if test="null!=cargo_nature  and ''!= cargo_nature">cargo_nature=#{cargo_nature} ,</if>
        <if test="null!=sku_out_why  and ''!= sku_out_why">sku_out_why=#{sku_out_why} ,</if>
        <if test="null!=order_get  and ''!= order_get">order_get=#{order_get} ,</if>
        <if test="null!=out_warehouse_img  and ''!= out_warehouse_img">out_warehouse_img=#{out_warehouse_img} ,</if>
        <if test="null!=remark  and ''!= remark">remark=#{remark} ,</if>
        <if test="null!=update_time  and ''!= update_time">update_time=#{update_time} ,</if>
        <if test="null!=is_delete  and ''!= is_delete">is_delete=#{is_delete} ,</if>
        <if test="null!=in_batch_number  and ''!= in_batch_number">in_batch_number=#{in_batch_number} ,</if>
        update_time = now()
        where
        1=1
        <if test="null!=id  and ''!= id">
            and id = #{id}
        </if>
    </update>

    <!-- 删除 -->
    <delete id="deleteInfo" parameterType="map">
        UPDATE w_order_no_sale_sku set is_delete = 'Y' WHERE id = #{id}
    </delete>

    <!-- 查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT
        a.*
        FROM
        w_order_no_sale_sku a
        WHERE a.is_delete = 'N'
        <include refid="sql_where"/>
        limit 0,1
    </select>


    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_no_sale_sku a
        LEFT JOIN w_warehouse_site_setting b on a.setting_id=b.id
        where
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER by a.id
    </select>

    <!-- 根据托盘id查找数据 -->
    <select id="queryTrayById" parameterType="map" resultType="dto">
        SELECT
        t.id AS tray_id,t.savearea,c.instock_time,c.sku_name,c.sku_level,c.sku_number,
        c.roduction_date,c.expiration_date,a.num,c.sku_type_number,c.sku_type_text,
        c.isexpired,c.bill,c.bill_photo,c.customer_id,k.client_name,s.`warehouse_area` AS storage_location
        FROM (
        SELECT
        SUM(stock) AS num,
        buy_checked_id,
        sku_id,
        provider_id,
        create_time,
        tray_id
        FROM
        w_order_store_sku
        WHERE `status` = 0
        GROUP BY
        buy_checked_id,sku_id,provider_id) a
        LEFT JOIN w_tray t ON a.tray_id = t.id
        LEFT JOIN w_order_buy_checked c ON a.buy_checked_id = c.id
        LEFT JOIN w_customer k ON c.customer_id=k.id
        LEFT JOIN w_warehouse_site_setting s ON c.warehouse_site_setting=s.id
        WHERE a.tray_id = #{id}
        ORDER by instock_time DESC
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <update id="updateStoreInfo" parameterType="map">
        UPDATE w_order_store_sku a set
        a.status = #{status},update_time = now()
        WHERE
        a.`status` in (0,1)
        <if test="null!=tray_id  and ''!= tray_id">
            and a.tray_id = #{tray_id}
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            and a.setting_id = #{setting_id}
        </if>
        <if test="null!=sku_id  and ''!= sku_id">
            and a.sku_id = #{sku_id}
        </if>
        <if test="null!=in_batch_number  and ''!= in_batch_number">
            and a.in_batch_number = #{in_batch_number}
        </if>
    </update>


    <!-- 查询 -->
    <select id="queryListBySku" parameterType="map" resultType="dto">
        SELECT
        a.*,b.number as setting_num,if(to_days(a.expiration_date) - to_days(now()) >= 0,'否','是') as is_expired,
        SUM(a.num) as total
        FROM
        w_order_no_sale_sku a
        LEFT JOIN w_warehouse_site_setting b on a.setting_id=b.id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
        GROUP BY a.sku_number
        ORDER BY a.sku_number, a.id desc
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>
    <!-- 列表数量查询 -->
    <select id="queryListBySkuCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_no_sale_sku a
        LEFT JOIN w_warehouse_site_setting b on a.setting_id=b.id
        where
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
        GROUP BY a.sku_number
    </select>


    <!-- 查询 -->
    <select id="queryListByCustomer" parameterType="map" resultType="dto">
        SELECT
        a.*,b.number as setting_num,if(to_days(a.expiration_date) - to_days(now()) >= 0,'否','是') as is_expired,
        SUM(a.num) as total
        FROM
        w_order_no_sale_sku a
        LEFT JOIN w_warehouse_site_setting b on a.setting_id=b.id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
        GROUP BY a.sku_number,a.customer_id
        ORDER BY a.customer_id,a.sku_number,a.id desc
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>
    <!-- 列表数量查询 -->
    <select id="queryListByCustomerCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_no_sale_sku a
        LEFT JOIN w_warehouse_site_setting b on a.setting_id=b.id
        where
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
        GROUP BY a.sku_number,a.customer_id
    </select>


    <!-- 查询 -->
    <select id="queryListByOrder" parameterType="map" resultType="dto">
        SELECT
        a.number,
        a.tray_number,
        GROUP_CONCAT(sku_name) AS sku_name,
        GROUP_CONCAT(sku_level) AS sku_level,
        b.number AS setting_num,
        SUM(a.num) AS total,
        a.sku_out_why,
        a.cargo_nature,
        a.create_time
        FROM
        w_order_no_sale_sku a
        LEFT JOIN w_warehouse_site_setting b ON a.setting_id = b.id
        WHERE a.is_delete = 'N'
        <include refid="sql_where"/>
        GROUP BY
        a.number
        ORDER BY
        a.id DESC
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>
    <!-- 列表数量查询 -->
    <select id="queryListByOrderCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM  (  SELECT
        a.number,
        a.tray_number,
        GROUP_CONCAT(sku_name) AS sku_name,
        GROUP_CONCAT(sku_level) AS sku_level,
        b.number AS setting_num,
        SUM(a.num) AS total
        FROM
        w_order_no_sale_sku a
        LEFT JOIN w_warehouse_site_setting b ON a.setting_id = b.id
        WHERE
        a.is_delete = 'N'
        <include refid="sql_where"/>
        GROUP BY
        a.number
        ORDER BY
        a.id DESC)a
    </select>

</mapper>
