<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="wtray">


    <sql id="sql_where">
        <if test="null!=savelocation  and ''!= savelocation">
            and a.savelocation = #{savelocation}
        </if>
        <if test="null!=tray_id  and ''!= tray_id">
            and a.tray_id = #{tray_id}
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            and a.setting_id = #{setting_id}
        </if>
        <if test="null!=number  and ''!= number">
            and a.number LIKE concat('%',#{number},'%')
        </if>
        <if test="null!=code  and ''!= code">
            and a.number LIKE concat('%',#{code},'%')
        </if>
        <if test="null!=names  and ''!= names">
            and a.name LIKE concat('%',#{names},'%')
        </if>
        <if test="null!=norm  and ''!= norm">
            and a.norm LIKE concat('%',#{norm},'%')
        </if>
        <if test="null!=maxweight  and ''!= maxweight">
            and a.maxweight LIKE concat('%',#{maxweight},'%')
        </if>
        <if test="null!=volume  and ''!= volume">
            and a.volume LIKE concat('%',#{volume},'%')
        </if>
        <if test="null!=warehouse_id  and ''!= warehouse_id">
            and wss.warehouse_id = #{warehouse_id}
        </if>
        <if test="null!=savearea  and ''!= savearea">
            and wss.warehouse_area_id=#{savearea}
        </if>
        <if test="null!=manager  and ''!= manager">
            and a.manager LIKE concat('%',#{manager},'%')
        </if>
        <if test="null!=dept  and ''!= dept">
            and a.dept_id LIKE concat('%',#{dept},'%')
        </if>
        <if test="null!=phone  and ''!= phone">
            and a.manager_mobile LIKE concat('%',#{phone},'%')
        </if>
        <if test="null!=tray_type  and ''!= tray_type">
            and a.tray_type =#{tray_type}
        </if>
        <if test="null!=remark  and ''!= remark">
            and a.remark LIKE concat('%',#{remark},'%')
        </if>
        <if test="null!=query  and ''!= query">
            and ( a.railway_platform LIKE concat('%',#{query},'%')  AND wss.number  is NULL )

        </if>
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>

        <if test="null!=isNoSite  and ''!= isNoSite">
            and a.savelocation is NULL
        </if>
        <if test="null!=in_batch_numbers">
            and a.in_batch_number in
            <foreach collection="in_batch_numbers" item="list" open="(" separator="," close=")">
                #{list}
            </foreach>
        </if>

    </sql>

    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT
        a.*,
        wss. NAME AS wname,
        d.dept_name,
        wss.number AS setting_number
        FROM
        w_tray a
        LEFT JOIN w_warehouse_site_setting wss ON wss.id = a.savelocation
        LEFT JOIN sys_dept d on a.dept_id = d.id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER BY id DESC
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>


    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        select
        count(1) as total
        FROM
        w_tray a
        LEFT JOIN w_warehouse_site_setting wss ON wss.id = a.savelocation
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
    </select>


    <!-- 插入 -->
    <insert id="saveInfo" parameterType="dto">
        insert into w_tray (

        <if test="null!=number  and ''!= number">number ,</if>
        <if test="null!=name  and ''!= name">name ,</if>
        <if test="null!=norm  and ''!= norm">norm ,</if>
        <if test="null!=maxweight  and ''!= maxweight">maxweight ,</if>
        <if test="null!=volume  and ''!= volume">volume ,</if>
        <if test="null!=warehouse_id  and ''!= warehouse_id">warehouse_id ,</if>
        <if test="null!=savearea  and ''!= savearea">savearea ,</if>
        <if test="null!=trayphoto  and ''!= trayphoto">trayphoto ,</if>
        <if test="null!=dept_id  and ''!= dept_id">dept_id ,</if>
        <if test="null!=manager  and ''!= manager">manager ,</if>
        <if test="null!=manager_mobile  and ''!= manager_mobile">manager_mobile ,</if>
        <if test="null!=savelocation  and ''!= savelocation">savelocation ,</if>
        <if test="null!=tray_type  and ''!= tray_type">tray_type ,</if>
        <if test="null!=remark  and ''!= remark">remark ,</if>
        <if test="null!=railway_platform  and ''!= railway_platform">railway_platform ,</if>
        create_time,
        update_time
        )
        VALUES
        (

        <if test="null!=number  and ''!= number">#{number} ,</if>
        <if test="null!=name  and ''!= name">#{name} ,</if>
        <if test="null!=norm  and ''!= norm">#{norm} ,</if>
        <if test="null!=maxweight  and ''!= maxweight">#{maxweight} ,</if>
        <if test="null!=volume  and ''!= volume">#{volume} ,</if>
        <if test="null!=warehouse_id  and ''!= warehouse_id">#{warehouse_id} ,</if>
        <if test="null!=savearea  and ''!= savearea">#{savearea} ,</if>
        <if test="null!=trayphoto  and ''!= trayphoto">#{trayphoto} ,</if>
        <if test="null!=dept_id  and ''!= dept_id">#{dept_id} ,</if>
        <if test="null!=manager  and ''!= manager">#{manager} ,</if>
        <if test="null!=manager_mobile  and ''!= manager_mobile">#{manager_mobile} ,</if>
        <if test="null!=savelocation  and ''!= savelocation">#{savelocation} ,</if>
        <if test="null!=tray_type  and ''!= tray_type">#{tray_type} ,</if>
        <if test="null!=remark  and ''!= remark">#{remark} ,</if>
        <if test="null!=railway_platform  and ''!= railway_platform">#{railway_platform} ,</if>
        now(),
        now()
        );
    </insert>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="dto">
        update w_tray
        set
        <if test="null!=name  and ''!= name">
            name = #{name},
        </if>
        <if test="null!=number  and ''!= number">
            number = #{number},
        </if>
        <if test="null!=norm  and ''!= norm">
            norm = #{norm},
        </if>
        <if test="null!=maxweight  and ''!= maxweight">
            maxweight = #{maxweight},
        </if>
        <if test="null!=volume  and ''!= volume">
            volume = #{volume},
        </if>
        <if test="null!=warehouse_id  and ''!= warehouse_id">
            warehouse_id = #{warehouse_id},
        </if>
        <if test="null!=savearea  and ''!= savearea">
            savearea = #{savearea},
        </if>
        <if test="null!=trayphoto  and ''!= trayphoto">
            trayphoto = #{trayphoto},
        </if>
        <if test="null!=dept_id  and ''!= dept_id">
            dept_id = #{dept_id},
        </if>
        <if test="null!=manager  and ''!= manager">
            manager = #{manager},
        </if>
        <if test="null!=manager_mobile  and ''!= manager_mobile">
            manager_mobile = #{manager_mobile},
        </if>

        <if test="null!=tray_type  and ''!= tray_type">
            tray_type = #{tray_type},
        </if>
        <if test="null!=remark  and ''!= remark">
            remark = #{remark},
        </if>
        <if test="null!=savelocation  and ''!= savelocation">
            savelocation = #{savelocation},
        </if>
        <if test="null!=updator  and ''!= updator">
            updator = #{updator},
        </if>
        <if test="null!=railway_platform  and ''!= railway_platform">
            railway_platform = #{railway_platform},
        </if>
        update_time = now()
        where id = #{id}
    </update>

    <!-- 删除 -->
    <delete id="deleteInfo" parameterType="map">
        UPDATE w_tray set is_delete = 'Y' WHERE id = #{id}
    </delete>


    <!-- 修改 -->
    <update id="updateSavelocation" parameterType="dto">
        update w_tray
        set
        savelocation = #{savelocation},
        updator = #{updator},
        update_time = now()
        where id = #{id}
    </update>


    <!-- 查询 -->
    <select id="queryOrderListForLocation" parameterType="map" resultType="dto">
        SELECT
        a.*,SUM(a.stock) numtotal,a.create_time as storage_time,
        b.`name` AS productname,b.level,b.number,b.unit_volume,b.unit_weight,
        c.number typenum,c.text typename,
        d.roduction_date,d.expiration_date,
        g.bill,
        to_days(
        ADDDATE(
        d.roduction_date,
        INTERVAL CEILING(
        d.shelflife * f.warningday_num
        ) DAY
        )
        ) - to_days(now()) AS distance_day,
        to_days(d.expiration_date) - to_days(now()) AS is_expired_days,
        f.client_name
        FROM
        w_order_store_sku a
        LEFT JOIN w_sku b ON a.sku_id = b.id
        LEFT JOIN w_sku_type c on b.type_id=c.id
        LEFT JOIN w_order_buy_sku d ON a.buy_sku_id = d.id
        LEFT JOIN w_customer f ON f.id = a.provider_id
        LEFT JOIN w_order_buy_checked g on g.id=a.buy_checked_id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        AND a.status in (0,1)
        <include refid="sql_where"/>
        GROUP BY a.in_batch_number
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>

    <!-- 查询库位信息 -->
    <select id="querySiteSettingList" parameterType="map" resultType="dto">
        SELECT
        a.*
        FROM
        w_warehouse_site_setting a
        LEFT JOIN w_tray t ON t.savelocation = a.id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        AND t.id IS NULL
        <if test="null!=number  and ''!= number">
            and a.number LIKE concat('%',#{number},'%')
        </if>
        <if test="null!=warehouse_id  and ''!= warehouse_id">
            and a.warehouse_id = #{warehouse_id}
        </if>
        <if test="null!=warehouse_area_id  and ''!= warehouse_area_id">
            and a.warehouse_area_id = #{warehouse_area_id}
        </if>
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>

    <!-- 查询 -->
    <select id="queryListForLocation" parameterType="map" resultType="dto">
        SELECT
        a.*,
        b.`name` AS productname,b.level,b.number,
        c.number typenum,c.text typename,
        d.roduction_date,d.expiration_date,
        to_days(
        ADDDATE(
        d.roduction_date,
        INTERVAL CEILING(
        d.shelflife * f.warningday_num
        ) DAY
        )
        ) - to_days(now()) AS distance_day
        FROM
        w_order_store_sku a
        LEFT JOIN w_sku b ON a.sku_id = b.id
        LEFT JOIN w_sku_type c on b.type_id=c.id
        LEFT JOIN w_order_buy_sku d ON a.buy_sku_id = d.id
        LEFT JOIN w_customer f ON f.id = a.provider_id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        <if test="null!=tray_id  and ''!= tray_id">
            and a.tray_id = #{tray_id}
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            and a.setting_id = #{setting_id}
        </if>
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>


    <!-- 列表数量查询 -->
    <select id="queryTrayCount" parameterType="map" resultType="dto">
        select
        count(1) as total
        FROM
        w_tray a
    </select>


</mapper>
