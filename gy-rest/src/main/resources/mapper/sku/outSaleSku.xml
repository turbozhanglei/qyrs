<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="outSaleSku">


    <sql id="sql_where">
        <if test="null!=status">
            and a.status = #{status}
        </if>
        <if test="null!=order_no  and ''!= order_no">
            and s.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=name  and ''!= name">
            and sku.name LIKE concat('%',#{name},'%')
        </if>
        <if test="null!=customer_no  and ''!= customer_no">
            and s.customer_no LIKE concat('%',#{customer_no},'%')
        </if>
        <if test="null!=order_licence  and ''!= order_licence">
            and s.order_licence LIKE concat('%',#{order_licence},'%')
        </if>
        <if test="null!=recipient_store  and ''!= recipient_store">
            and s.recipient_store LIKE concat('%',#{recipient_store},'%')
        </if>
        <if test="null!=recipient_store_address  and ''!= recipient_store_address">
            and s.recipient_store_address LIKE concat('%',#{recipient_store_address},'%')
        </if>
        <if test="null!=out_stock_num  and ''!= out_stock_num">
            and a.out_stock_num LIKE concat('%',#{out_stock_num},'%')
        </if>
        <if test="null!=startdate  and ''!= startdate">
            and s.out_stock >= #{startdate}
        </if>
        <if test="null!=enddate  and ''!= enddate">
            and s.out_stock &lt;= #{enddate}
        </if>
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
        <if test="null!=customer_id  and ''!= customer_id">
            and s.customer_id = #{customer_id}
        </if>
    </sql>

    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT
        a.*, s.*, sku.`name`,
        c.val AS statusval,
        b.driver_id,
        d.drivername,
        d.driver_number,
        oss.warehouse_number AS warehouse_number,
        oss.tray_number as tray_number,
        sku.unit_volume,
        sku.unit_weight,
        sku.`level`,
        wc.client_name
        FROM
        w_order_sale_sku AS a
        LEFT JOIN w_order_sale s ON a.sale_id = s.id
        LEFT JOIN w_sku sku ON a.sku_id = sku.id
        LEFT JOIN sys_config c ON a.`status` = c.id
        LEFT JOIN w_order_sale_sku_driver b ON a.id = b.sale_sku_id
        LEFT JOIN w_driverinfo d ON b.driver_id = d.id
        LEFT JOIN  (
        SELECT
        oss.in_batch_number,
        t.number AS tray_number,
        e.number AS warehouse_number
        FROM
        w_order_store_sku oss
        LEFT JOIN w_tray t ON oss.tray_id = t.id
        LEFT JOIN w_warehouse_site_setting e ON oss.setting_id = e.id
        GROUP BY
        oss.in_batch_number
        ) oss on oss.in_batch_number = a.in_batch_number
        LEFT JOIN w_customer wc on s.customer_id = wc.id
        WHERE
        a.is_delete = 'N'
        AND a. STATUS = 50

        <include refid="sql_where"/>
        ORDER BY a.id DESC
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>


    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_order_sale_sku AS a
        LEFT JOIN w_order_sale s ON a.sale_id = s.id
        LEFT JOIN w_sku sku ON a.sku_id = sku.id
        LEFT JOIN sys_config c ON a.`status` = c.id
        LEFT JOIN w_order_sale_sku_driver b ON a.id = b.sale_sku_id
        LEFT JOIN w_driverinfo d ON b.driver_id = d.id
        WHERE
        a.is_delete = 'N'
        AND a. STATUS = 50
        <include refid="sql_where"/>
    </select>


</mapper>
