<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->

<!-- 参数管理手工映射SQL语句 -->
<!-- 预期到货通知表 -->
<mapper namespace="wOrderAsn">

    <sql id="sql_where">
        where
        a.is_delete = 'N'
        <if test="null!=_id  and ''!= _id">
            and a.id = #{_id}
        </if>
        <if test="null!=_order_no  and ''!= _order_no">
            and a.order_no = #{_order_no}
        </if>
        <if test="null!=_contract_id  and ''!= _contract_id">
            and a.contract_id = #{_contract_id}
        </if>
        <if test="null!=_coma  and ''!= _coma">
            and a.coma = #{_coma}
        </if>
        <if test="null!=_comb  and ''!= _comb">
            and a.comb = #{_comb}
        </if>
        <if test="null!=_amount  and ''!= _amount">
            and a.amount = #{_amount}
        </if>
        <if test="null!=_start_time  and ''!= _start_time">
            and a.start_time = #{_start_time}
        </if>
        <if test="null!=_end_time  and ''!= _end_time">
            and a.end_time = #{_end_time}
        </if>
        <if test="null!=_create_order_time  and ''!= _create_order_time">
            and a.create_order_time = #{_create_order_time}
        </if>
        <if test="null!=_create_order_user  and ''!= _create_order_user">
            and a.create_order_user = #{_create_order_user}
        </if>
        <if test="null!=_enter_library_time  and ''!= _enter_library_time">
            and a.enter_library_time = #{_enter_library_time}
        </if>
        <if test="null!=_status  and ''!= _status">
            and a.status = #{_status}
        </if>
        <if test="null!=startDate  and ''!= startDate">
            and a.create_time >= concat(#{startDate},' ','00:00:00')
        </if>
        <if test="null!=endDate  and ''!= endDate">
            and a.create_time &lt;= concat(#{endDate},' ','23:59:59')
        </if>
        <if test="null!=_creator  and ''!= _creator">
            and a.creator = #{_creator}
        </if>
        <if test="null!=_update_time  and ''!= _update_time">
            and a.update_time = #{_update_time}
        </if>
        <if test="null!=_updator  and ''!= _updator">
            and a.updator = #{_updator}
        </if>

    </sql>

    <!-- 列表查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        /*SELECT
        a.id,
        wcp.name AS provider_name,
        wcp2.name AS comb,
        case a.order_type
        when '0' then '订货单'
        when '1' then '补货单'
        when '2' then 'ASN单'
        else '未知' end
        as order_type,
        woa.order_no,
        su.username as creator,
        woa.create_order_time,
        woa.enter_library_time,
        case woa.status
        when '0' then '不同意'
        when '1' then '已同意'
        else '未知' end
        as status
        FROM
        w_order_store_sku a
        LEFT JOIN w_cmn_provider wcp ON wcp.id = a.provider_id
        LEFT JOIN w_order_asn woa ON woa.id = a.order_id
        LEFT JOIN w_cmn_provider wcp2 ON wcp2.id = woa.comb
        left join sys_user su ON su.id = woa.creator*/
        SELECT
        a.*, s.val AS ordertype,
        c.`name` AS ownername,
        c1.`name` AS providername,
        s1.val AS priorityval,
        s2.val as status_val
        FROM
        w_order_asn a
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_carrier_id = c1.id
        LEFT JOIN sys_config s ON a.order_type = s.id
        LEFT JOIN sys_config s1 ON a.priority = s1.id
        LEFT JOIN sys_config s2 ON a.status = s2.id
        WHERE
        a.is_delete = 'N'
        <if test="null!=id   and ''!= id ">
            and a.id=#{id}
        </if>
        <if test="null!=_warehouse_id   and ''!= _warehouse_id ">
            and a.order_no=#{_warehouse_id}
        </if>
        <if test="null!=status   and ''!= status ">
            and a.status=#{status}
        </if>
        <if test="null!=type   and ''!= type ">
            and a.type=#{type}
        </if>
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 插入 -->
    <insert id="saveInfo" parameterType="map">
        insert into w_order_asn (order_no, order_type,
        provider_id, provider_carrier_id, provider_owner_id,
        carrier,priority, start_time,
        end_time, purchase, receive,type,
        remark, status, t_status,create_time,
        creator, is_delete)
        values (#{order_no}, #{order_type},
        #{provider_id}, #{provider_carrier_id}, #{provider_owner_id},
        #{carrier},#{priority}, #{start_time},
        #{end_time}, #{purchase}, #{receive},#{type},
        #{remark}, #{status}, #{t_status},now(), #{creator}, 'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 删除 -->
    <update id="deleteInfo" parameterType="map">
        UPDATE w_order_asn set is_delete = 'Y' where id = #{id}
    </update>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="map">
        UPDATE w_order_asn a
        set

        <if test="null!=order_no  and ''!= order_no">
            a.order_no = #{order_no} ,
        </if>
        <if test="null!=contract_id  and ''!= contract_id">
            a.contract_id = #{contract_id} ,
        </if>
        <if test="null!=coma  and ''!= coma">
            a.coma = #{coma} ,
        </if>
        <if test="null!=comb  and ''!= comb">
            a.comb = #{comb} ,
        </if>
        <if test="null!=amount  and ''!= amount">
            a.amount = #{amount} ,
        </if>
        <if test="null!=start_time  and ''!= start_time">
            a.start_time = #{start_time} ,
        </if>
        <if test="null!=end_time  and ''!= end_time">
            a.end_time = #{end_time} ,
        </if>
        <if test="null!=create_order_time  and ''!= create_order_time">
            a.create_order_time = #{create_order_time} ,
        </if>
        <if test="null!=create_order_user  and ''!= create_order_user">
            a.create_order_user = #{create_order_user} ,
        </if>
        <if test="null!=enter_library_time  and ''!= enter_library_time">
            a.enter_library_time = #{enter_library_time} ,
        </if>
        <if test="null!=status">
            a.status = #{status} ,
        </if>
        <if test="null!=t_status  and ''!= t_status">
            a.t_status = #{t_status} ,
        </if>
        <if test="null!=type">
            a.type = #{type} ,
        </if>
        <if test="null!=create_time  and ''!= create_time">
            a.create_time = #{create_time} ,
        </if>
        <if test="null!=creator  and ''!= creator">
            a.creator = #{creator} ,
        </if>
        <if test="null!=is_delete  and ''!= is_delete">
            a.is_delete = #{is_delete} ,
        </if>
        update_time = now(),
        a.updator = #{updator}
        where
        a.id = #{id}
    </update>


    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_order_asn a
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_id = c1.id
        LEFT JOIN sys_config s ON a.order_type = s.id
        LEFT JOIN sys_config s1 ON a.priority = s1.id
        WHERE
        a.is_delete = 'N'
        <if test="null!=id   and ''!= id ">
            and a.id=#{id}
        </if>
        <if test="null!=_warehouse_id   and ''!= _warehouse_id ">
            and a.order_no=#{_warehouse_id}
        </if>
        <if test="null!=status   and ''!= status ">
            and a.status=#{status}
        </if>
        <if test="null!=type   and ''!= type ">
            and a.type=#{type}
        </if>
    </select>

    <!-- 对象查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT
        a.*, s.val AS ordertype,
        c.`name` AS ownername,
        c1.`name` AS providername,
        s1.val AS priorityval
        FROM
        w_order_asn a
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_id = c1.id
        LEFT JOIN sys_config s ON a.order_type = s.id
        LEFT JOIN sys_config s1 ON a.priority = s1.id
        where a.is_delete='N'
        <if test="null!=id   and ''!= id ">
            and a.id=#{id}
        </if>
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no = #{order_no}
        </if>
        limit 0,1
    </select>


    <!--ASN收货列表-->
    <select id="queryAsnGoods" parameterType="map" resultType="dto">
        SELECT
        a.*, s.val AS ordertype,
        c.`name` AS ownername,
        c1.`name` AS providername,
        s1.val AS priorityval,
        z.`receiving_status` as statusval,
        z.sku_id,
        z.id as ids
        FROM
        w_order_asn_sku AS z
        LEFT JOIN w_order_asn a ON (z.order_id = a.id)
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_id = c1.id
        LEFT JOIN sys_config s ON a.order_type = s.id
        LEFT JOIN sys_config s1 ON a.priority = s1.id
        WHERE
        a.is_delete = 'N'
        <if test="null!=id   and ''!= id ">
            and a.id=#{id}
        </if>
        <if test="null!=status   and ''!= status ">
            and z.receiving_status=#{status}
        </if>
        <if test="null!=statuss   and ''!= statuss ">
            and a.status=#{statuss}
        </if>
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!--ASN收货列表-->
    <select id="queryAsnGoodsCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_order_asn_sku AS z
        LEFT JOIN w_order_asn a ON (z.order_id = a.id)
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_id = c1.id
        LEFT JOIN sys_config s ON a.order_type = s.id
        LEFT JOIN sys_config s1 ON a.priority = s1.id
        WHERE
        a.is_delete = 'N'
        <if test="null!=id   and ''!= id ">
            and a.id=#{id}
        </if>
        <if test="null!=status   and ''!= status ">
            and z.receiving_status=#{status}
        </if>
    </select>


    <!--查询订单下商品是否全部打包-->
    <select id="getOrderProductPackInfo" parameterType="map" resultType="dto">
        SELECT
        count(b.id) as pack_count,
        (
        SELECT
        wa.t_status
        FROM
        w_order_sale_sku AS oa
        left join w_order_asn as wa on(oa.order_id=wa.id)
        WHERE
        oa.sale_id = #{order_id}
        ) as t_status,
        (
        SELECT
        oa.order_no
        FROM
        w_order_sale AS oa
        WHERE
        oa.id = #{order_id}
        ) as order_no,
        (
        SELECT
        count(c.id)
        FROM
        w_order_sale_sku AS c
        WHERE
        c.sale_id = #{order_id}
        ) as total_count
        FROM
        w_package_pick AS b
        left join w_picking_sku as c on(b.picking_id=c.picking_id)
        left join w_batch_allot as e on(e.id=c.allot_id)
        LEFT JOIN w_order_sale AS a ON (a.id = e.sale_order_id)
        WHERE
        a.id = #{order_id}
    </select>

    <update id="updateTmsOrderStatus" parameterType="map">
        update new_oms.oms_order set status=#{status} where order_no=#{order_no}
    </update>
</mapper>
