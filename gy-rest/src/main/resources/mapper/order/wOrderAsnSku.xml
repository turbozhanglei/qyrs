<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->

<!-- 参数管理手工映射SQL语句 -->
<!-- ASN表商品关联表 -->
<mapper namespace="wOrderAsnSku">

    <sql id="sql_where">
        where
        a.is_delete = 'N'
        <if test="null!=_id  and ''!= _id">
            and a.id = #{_id}
        </if>
        <if test="null!=_sku_id  and ''!= _sku_id">
            and a.sku_id = #{_sku_id}
        </if>
        <if test="null!=_order_id  and ''!= _order_id">
            and a.order_id = #{_order_id}
        </if>
        <if test="null!=_batch_number  and ''!= _batch_number">
            and a.batch_number = #{_batch_number}
        </if>
        <if test="null!=_stock  and ''!= _stock">
            and a.stock = #{_stock}
        </if>
        <if test="null!=_measure_unit  and ''!= _measure_unit">
            and a.measure_unit = #{_measure_unit}
        </if>
        <if test="null!=_price  and ''!= _price">
            and a.price = #{_price}
        </if>
        <if test="null!=_amount  and ''!= _amount">
            and a.amount = #{_amount}
        </if>
        <if test="null!=_status  and ''!= _status">
            and a.status = #{_status}
        </if>
        <if test="null!=_remark  and ''!= _remark">
            and a.remark = #{_remark}
        </if>
        <if test="null!=startDate  and ''!= startDate">
            and a.create_time >= concat(#{startDate},' ','00:00:00')
        </if>
        <if test="null!=endDate  and ''!= endDate">
            and a.create_time &lt;= concat(#{endDate},' ','23:59:59')
        </if>
        <if test="null!=_creator  and ''!= _creator">
            and a.creator = #{_creator}
        </if>
        <if test="null!=_update_time  and ''!= _update_time">
            and a.update_time = #{_update_time}
        </if>
        <if test="null!=_updator  and ''!= _updator">
            and a.updator = #{_updator}
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            and a.setting_id = #{setting_id}
        </if>
    </sql>

    <!-- 插入 -->
    <insert id="saveInfo" parameterType="map">
        INSERT INTO
        w_order_asn_sku (

        <if test="null!=sku_id  and ''!= sku_id">
            sku_id ,
        </if>
        <if test="null!=order_id  and ''!= order_id">
            order_id ,
        </if>
        <if test="null!=batch_number  and ''!= batch_number">
            batch_number ,
        </if>
        <if test="null!=stock  and ''!= stock">
            stock ,
        </if>
        <if test="null!=measure_unit  and ''!= measure_unit">
            measure_unit ,
        </if>
        <if test="null!=price  and ''!= price">
            price ,
        </if>
        <if test="null!=amount  and ''!= amount">
            amount ,
        </if>
        <if test="null!=status">
            status ,
        </if>
        <if test="null!=remark  and ''!= remark">
            remark ,
        </if>
        <if test="null!=period_time  and ''!= period_time">
            period_time ,
        </if>
        <if test="null!=period  and ''!= period">
            period ,
        </if>
        create_time,
        creator,
        update_time,
        updator
        ) VALUES(

        <if test="null!=sku_id  and ''!= sku_id">
            #{sku_id} ,
        </if>
        <if test="null!=order_id  and ''!= order_id">
            #{order_id} ,
        </if>
        <if test="null!=batch_number  and ''!= batch_number">
            #{batch_number} ,
        </if>
        <if test="null!=stock  and ''!= stock">
            #{stock} ,
        </if>
        <if test="null!=measure_unit  and ''!= measure_unit">
            #{measure_unit} ,
        </if>
        <if test="null!=price  and ''!= price">
            #{price} ,
        </if>
        <if test="null!=amount  and ''!= amount">
            #{amount} ,
        </if>
        <if test="null!=status">
            #{status} ,
        </if>
        <if test="null!=remark  and ''!= remark">
            #{remark} ,
        </if>
        <if test="null!=period_time  and ''!= period_time">
            #{period_time} ,
        </if>
        <if test="null!=period  and ''!= period">
            #{period} ,
        </if>
        now(),
        #{creator},
        now(),
        #{updator}
        );
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 删除 -->
    <update id="deleteInfo" parameterType="map">
        UPDATE w_order_asn_sku set is_delete = 'Y' where id = #{id}
    </update>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="map">
        UPDATE w_order_asn_sku a
        set

        <if test="null!=sku_id  and ''!= sku_id">
            a.sku_id = #{sku_id} ,
        </if>
        <if test="null!=order_id  and ''!= order_id">
            a.order_id = #{order_id} ,
        </if>
        <if test="null!=batch_number  and ''!= batch_number">
            a.batch_number = #{batch_number} ,
        </if>
        <if test="null!=package  and ''!= package">
            a.package = #{package} ,
        </if>
        <if test="null!=num  and ''!= num">
            a.num = #{num} ,
        </if>
        <if test="null!=ea_num  and ''!= ea_num">
            a.ea_num = #{ea_num} ,
        </if>
        <if test="null!=rough_weight  and ''!= rough_weight">
            a.rough_weight = #{rough_weight} ,
        </if>
        <if test="null!=net_weight  and ''!= net_weight">
            a.net_weight = #{net_weight} ,
        </if>
        <if test="null!=volume  and ''!= volume">
            a.volume = #{volume} ,
        </if>
        <if test="null!=worth  and ''!= worth">
            a.worth = #{worth} ,
        </if>
        <if test="null!=rejection  and ''!= rejection">
            a.rejection = #{rejection} ,
        </if>
        <if test="null!=rejection_remark  and ''!= rejection_remark">
            a.rejection_remark = #{rejection_remark} ,
        </if>
        <if test="null!=trace_number  and ''!= trace_number">
            a.trace_number = #{trace_number} ,
        </if>
        <if test="null!=receiving_status  and ''!= receiving_status">
            a.receiving_status = #{receiving_status} ,
        </if>
        <if test="null!=stock  and ''!= stock">
            a.stock = #{stock} ,
        </if>
        <if test="null!=lock_stock_add  and ''!= lock_stock_add">
            a.lock_stock = a.lock_stock+#{lock_stock_add} ,
        </if>
        <if test="null!=lock_stock_sub  and ''!= lock_stock_sub">
            a.lock_stock = a.lock_stock-#{lock_stock_sub} ,
        </if>
        <if test="null!=measure_unit  and ''!= measure_unit">
            a.measure_unit = #{measure_unit} ,
        </if>
        <if test="null!=price  and ''!= price">
            a.price = #{price} ,
        </if>
        <if test="null!=status">
            a.status = #{status} ,
        </if>
        <if test="null!=remark  and ''!= remark">
            a.remark = #{remark} ,
        </if>
        <if test="null!=period_time  and ''!= period_time">
            a.period_time=#{period_time} ,
        </if>
        <if test="null!=period  and ''!= period">
            a.period=#{period} ,
        </if>
        <if test="null!=create_time  and ''!= create_time">
            a.create_time = #{create_time} ,
        </if>
        <if test="null!=creator  and ''!= creator">
            a.creator = #{creator} ,
        </if>
        <if test="null!=is_delete  and ''!= is_delete">
            a.is_delete = #{is_delete} ,
        </if>
        update_time = now(),
        a.updator = #{updator}
        where
        a.id = 2
    </update>

    <!-- 列表查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        <!--SELECT
        woa.id,
        woa.order_no,
        wcp.name as comb,
        woa.amount,
        woa.enter_library_time,
        su.username as create_order_user,
        GROUP_CONCAT(ws.name) as sku_name,
        GROUP_CONCAT(a.batch_number) as batch_number,
        GROUP_CONCAT(a.stock) as stock,
        GROUP_CONCAT(a.measure_unit) as measure_unit,
        GROUP_CONCAT(a.price) as price,
        case woa.status
        when '0' then '不同意'
        when '1' then '同意'
        else '未知'
        end as status,
        woa.create_time
        FROM
        w_order_asn_sku a
        left join w_order_asn woa ON woa.id = a.order_id
        left join w_cmn_provider wcp ON wcp.id = woa.comb
        left join w_sku ws ON ws.id = a.sku_id
        left join sys_user su ON su.id = woa.create_order_user
        <include refid="sql_where"/>
        and woa.id is not null
        group by woa.id desc-->
        SELECT
        a.*, b. NAME as names
        FROM
        w_order_asn_sku a
        LEFT JOIN w_sku b ON a.sku_id = b.id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        <if test="null!=order_id  and ''!= order_id">
            and a.order_id = #{order_id}
        </if>
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        <!--SELECT
        count(1) as total
        FROM
        w_order_asn_sku a
        left join w_order_asn woa ON woa.id = a.order_id
        left join w_cmn_provider wcp ON wcp.id = woa.comb
        left join w_sku ws ON ws.id = a.sku_id
        left join sys_user su ON su.id = woa.create_order_user
        <include refid="sql_where"/>
        and woa.id is not null
        group by woa.id-->
        SELECT count(1) as total
        FROM
        w_order_asn_sku a
        LEFT JOIN w_sku b on a.sku_id=b.id
        where 1=1
        and a.is_delete='N'
        <if test="null!=order_id  and ''!= order_id">
            and a.order_id = #{order_id}
        </if>
    </select>

    <!-- 对象查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT
        a.*
        FROM
        w_order_asn_sku a
        <include refid="sql_where"/>
    </select>

    <select id="queryAsnSkuList" parameterType="map" resultType="dto">
        SELECT
        *
        FROM
        (
        <if test="null!=sale_id  and ''!= sale_id">
            SELECT
            b.*, a.out_stock_num,c.val as status_val,b.stock-b.lock_stock as dostock,1 as isok
            FROM
            w_order_sale_sku AS a
            LEFT JOIN w_order_asn_sku AS b ON (
            a.sku_id = b.sku_id
            )
            left join sys_config as c on(c.id=a.status)
            where a.sale_id=#{sale_id}
            UNION ALL
        </if>
        SELECT
        a.*, 0 AS out_stock_num,c.val as status_val,a.stock-a.lock_stock as dostock,
        0 AS isok
        FROM
        w_order_asn_sku AS a
        left join w_order_asn AS b on (a.order_id=b.id)
        left join sys_config as c on(c.id=a.status)
        WHERE
        b.provider_owner_id = #{setting_id}
        AND a.stock != 0
        ) AS a
        GROUP BY a.id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <select id="queryAsnSkuListCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        (
        <if test="null!=sale_id  and ''!= sale_id">
            SELECT
            b.*, a.out_stock_num,c.val as status_val,b.stock-b.lock_stock as dostock,1 as isok
            FROM
            w_order_sale_sku AS a
            LEFT JOIN w_order_asn_sku AS b ON (
            a.order_id = b.order_id
            AND a.sku_id = b.sku_id
            )
            left join sys_config as c on(c.id=a.status)
            where a.sale_id=#{sale_id}
            UNION ALL
        </if>
        SELECT
        a.*, 0 AS out_stock_num,c.val as status_val,a.stock-a.lock_stock as dostock,
        0 AS isok
        FROM
        w_order_asn_sku AS a
        left join w_order_asn AS b on (a.order_id=b.id)
        left join sys_config as c on(c.id=a.status)
        WHERE
        b.provider_owner_id = #{setting_id}
        AND a.stock != 0
        ) AS a
        GROUP BY a.id
    </select>


    <select id="orderAsnSkuReportList" parameterType="map" resultType="dto">
        SELECT a.*,GROUP_CONCAT(o.name,',') as sku_name,c.`name` as ownername,c1.`name` as providername,
        s.val as priorityval
        FROM w_order_asn a
        LEFT JOIN w_order_asn_sku o on o.order_id = a.id
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_id = c1.id
        LEFT JOIN sys_config s ON a.priority = s.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=ownername  and ''!= ownername">
            and c.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and c1.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=priority  and ''!= priority">
            and a.priority = #{priority}
        </if>
        GROUP BY a.id
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>

    <select id="orderAsnSkuReportCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_asn a
        LEFT JOIN w_order_asn_sku o on o.order_id = a.id
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_id = c1.id
        LEFT JOIN sys_config s ON a.priority = s.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=ownername  and ''!= ownername">
            and c.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and c1.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=priority  and ''!= priority">
            and a.priority = #{priority}
        </if>
        GROUP BY a.id
    </select>

    <select id="receiptListReport" parameterType="map" resultType="dto">
        SELECT a.*,c.`name` as ownername,c1.`name` as providername,
        o.purchase,o.receive,o.order_no,ss.`name` as settingname
        FROM w_order_asn_sku a
        LEFT JOIN w_order_asn o ON a.order_id = o.id
        LEFT JOIN w_cmn_provider c ON o.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON o.provider_id = c1.id
        LEFT JOIN w_warehouse_site_setting ss ON a.setting_id = ss.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=ownername  and ''!= ownername">
            and c.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and c1.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=priority  and ''!= priority">
            and a.priority = #{priority}
        </if>
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>


    <select id="receiptListReportCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_asn_sku a
        LEFT JOIN w_order_asn o ON a.order_id = o.id
        LEFT JOIN w_cmn_provider c ON o.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON o.provider_id = c1.id
        LEFT JOIN w_warehouse_site_setting ss ON a.setting_id = ss.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=ownername  and ''!= ownername">
            and c.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and c1.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=priority  and ''!= priority">
            and a.priority = #{priority}
        </if>
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!--查询未收货货主-->
    <select id="queryNoGoodOwnerLists" parameterType="map" resultType="dto">
        SELECT
        d.`name`,
        d.id
        FROM
        w_order_asn_sku as a
        LEFT JOIN w_order_buy_sku as b on(a.sku_id!=b.sku_id)
        LEFT JOIN w_order_buy as c on (b.order_id=c.id)
        LEFT JOIN w_cmn_provider as d on (c.provider_owner_id=d.id)
        <if test="null!=order_no  and ''!= order_no">
            where c.order_no=#{order_no}
        </if>
        GROUP BY d.id
    </select>

    <!--查询未收货货主-->
    <select id="queryNoGoodOwnerTwoLists" parameterType="map" resultType="dto">
        SELECT
        b.sku_id as id,
        d.`name`,
        b.num
        FROM
        w_order_asn_sku as a
        LEFT JOIN w_order_buy_sku as b on(a.sku_id!=b.sku_id)
        LEFT JOIN w_order_buy as c on (b.order_id=c.id)
        LEFT JOIN w_sku as d on (d.id=b.sku_id)
        where c.provider_owner_id=#{provider_owner_id}
    </select>


    <select id="querySkuByName" parameterType="map" resultType="dto">
        SELECT a.id
        FROM w_sku a
        WHERE 1 = 1
        and a.name=#{name}
        AND a.is_delete = 'N'
        limit 1
    </select>


    <insert id="saveSkuInfo" parameterType="map">
        INSERT INTO
        w_sku (


        <if test="null!=name  and ''!= name">
            name ,
        </if>
        <if test="null!=number  and ''!= number">
            number ,
        </if>
        <if test="null!=price  and ''!= price">
            price ,
        </if>
        <if test="null!=introduction  and ''!= introduction">
            introduction ,
        </if>
        <if test="null!=typed  and ''!= typed">
            typed ,
        </if>
        <if test="null!=level  and ''!= level">
            level ,
        </if>
        <if test="null!=sort  and ''!= sort">
            sort ,
        </if>
        <if test="null!=type_id  and ''!= type_id">
            type_id ,
        </if>
        <if test="null!=describes  and ''!= describes">
            describes ,
        </if>
        <if test="null!=status">
            status ,
        </if>

        create_time,

        update_time

        ) VALUES(

        <if test="null!=name  and ''!= name">
            #{name} ,
        </if>
        <if test="null!=number  and ''!= number">
            #{number} ,
        </if>
        <if test="null!=price  and ''!= price">
            #{price} ,
        </if>
        <if test="null!=introduction  and ''!= introduction">
            #{introduction} ,
        </if>
        <if test="null!=typed  and ''!= typed">
            #{typed} ,
        </if>
        <if test="null!=level  and ''!= level">
            #{level} ,
        </if>
        <if test="null!=sort  and ''!= sort">
            #{sort} ,
        </if>
        <if test="null!=type_id  and ''!= type_id">
            #{type_id} ,
        </if>
        <if test="null!=describes  and ''!= describes">
            #{describes} ,
        </if>
        <if test="null!=status">
            #{status} ,
        </if>
        now(),

        now()

        );
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>
</mapper>
