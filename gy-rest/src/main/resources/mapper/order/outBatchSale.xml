<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="outBatchSale">


    <sql id="sql_where">
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
    </sql>

    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT a.*
        FROM w_out_batch_sale a
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER BY id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        select
        count(1) as total
        FROM w_out_batch_sale a
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
    </select>

    <!-- 查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT a.*
        FROM w_out_batch_sale a
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
        limit 0,1
    </select>


    <!-- 插入 -->
    <insert id="saveInfo" parameterType="dto">
        insert into w_out_batch_sale (batch_id, order_id,create_time,
        creator, is_delete)
        values (#{batch_id}, #{order_id}, now(),
        #{creator}, 'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="dto">
        update w_out_batch_sale
        set
        <if test="null!=batch_no  and ''!= batch_no">
            batch_no = #{batch_no},
        </if>
        <if test="null!=batch_type  and ''!= batch_type">
            batch_type = #{batch_type}
        </if>
        where id = #{id}
    </update>

    <!-- 删除 -->
    <delete id="deleteInfo" parameterType="map">
        UPDATE w_out_batch_sale set is_delete = 'Y' WHERE id = #{id}
    </delete>

    <!-- 根据波次id和订单id删除 -->
    <delete id="deleteInfoByBaAndOrder" parameterType="map">
        delete from w_out_batch_sale WHERE batch_id = #{batch_id} and order_id=#{order_id}
    </delete>


    <!-- 查询波次订单明细 -->
    <select id="queryBatchOrderLists" parameterType="map" resultType="dto">
        SELECT
        c.*,b.out_stock_num,d.val as status_val,ifnull(e.out_stock_num,0) as stock_num,b.sale_id as ids
        FROM
        w_out_batch_sale AS a
        LEFT JOIN w_order_sale_sku AS b ON (a.order_id = b.sale_id)
        LEFT JOIN w_order_asn_sku AS c ON (b.sku_id = c.sku_id)
        left JOIN w_batch_allot AS e ON (e.batch_id = a.batch_id and e.sale_order_id=a.order_id)
        LEFT JOIN sys_config as d on (c.`status`=d.id)
        WHERE
        a.batch_id = #{batch_id}
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 查询波次订单明细 -->
    <select id="queryBatchOrderListsCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_out_batch_sale AS a
        LEFT JOIN w_order_sale_sku AS b ON (a.order_id = b.sale_id)
        LEFT JOIN w_order_asn_sku AS c ON (b.sku_id = c.sku_id)
        left JOIN w_batch_allot AS e ON (e.batch_id = a.batch_id and e.sale_order_id=a.order_id and b.sku_id=e.sku_id)
        LEFT JOIN sys_config as d on (c.`status`=d.id)
        WHERE
        a.batch_id = #{batch_id}
    </select>


    <!-- 查询波次分配明细 -->
    <select id="queryBatchAllotLists" parameterType="map" resultType="dto">
        SELECT
        c.*,a.allot_no, a.out_stock_num,e.out_stock_num as stock_num,
        d.val AS status_val
        FROM
        w_batch_allot AS a
        LEFT JOIN w_order_asn_sku AS c ON (a.sku_id = c.sku_id)
        LEFT JOIN w_order_sale_sku AS e ON (
        e.sale_id = a.sale_order_id
        AND a.sku_id = e.sku_id
        )
        LEFT JOIN sys_config AS d ON (c.`status` = d.id)
        WHERE
        a.batch_id = #{batch_id}
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <select id="queryBatchAllotListsCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_batch_allot AS a
        LEFT JOIN w_order_asn_sku AS c ON (a.sku_id = c.sku_id)
        LEFT JOIN w_order_sale_sku AS e ON (
        e.sale_id = a.sale_order_id
        AND a.sku_id = e.sku_id
        )
        LEFT JOIN sys_config AS d ON (c.`status` = d.id)
        WHERE
        a.batch_id = #{batch_id}
    </select>
</mapper>
