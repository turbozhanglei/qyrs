<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="outBatch">


    <sql id="sql_where">
        <if test="null!=status">
            and a.status = #{status}
        </if>
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
    </sql>

    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT a.*,b.val as batch_type_name,c.val as status_name
        FROM w_out_batch a
        left join sys_config as b on(a.batch_type=b.id)
        left join sys_config as c on(a.status=c.id)
        WHERE a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER BY id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        select
        count(1) as total
        FROM w_out_batch a
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
    </select>

    <!-- 查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT a.*
        FROM w_out_batch a
        WHERE a.is_delete = 'N'
        <include refid="sql_where"/>
        limit 0,1
    </select>


    <!-- 插入 -->
    <insert id="saveInfo" parameterType="dto">
        insert into w_out_batch (batch_no, batch_type,
        remark, status, create_time,
        creator, is_delete)
        values (#{batch_no}, #{batch_type},
        #{remark},#{status}, now(),
        #{creator}, 'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="dto">
        update w_out_batch
        set
        <if test="null!=batch_no  and ''!= batch_no">
            batch_no = #{batch_no},
        </if>
        <if test="null!=batch_type  and ''!= batch_type">
            batch_type = #{batch_type},
        </if>
        <if test="null!=remark  and ''!= remark">
            remark = #{remark},
        </if>
        <if test="null!=status">
            status = #{status},
        </if>
        <if test="null!=updator  and ''!= updator">
            updator = #{updator},
        </if>
        update_time = now()
        where id = #{id}
    </update>

    <!-- 删除 -->
    <delete id="deleteInfo" parameterType="map">
        UPDATE w_out_batch set is_delete = 'Y' WHERE id = #{id}
    </delete>


    <!-- 查询未分配发货单 -->
    <select id="queryNoSendGoods" parameterType="map" resultType="dto">
        SELECT
        a.id,
        a.order_no,
        c.`name` as provider_owner_name,
        d.val as order_type_name,
        e.val as priority_name,
        a.create_time
        FROM
        w_order_sale AS a
        LEFT JOIN w_cmn_provider AS c ON (a.provider_owner_id = c.id)
        LEFT JOIN sys_config AS d ON (d.id = a.order_type)
        LEFT JOIN sys_config AS e ON (e.id = a.priority)
        where a.status = 725

        <if test="null!=batch_id  and ''!= batch_id">

        </if>

        order by a.id desc
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <select id="queryNoSendGoodsCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_order_sale AS a
        LEFT JOIN w_cmn_provider AS c ON (a.provider_owner_id = c.id)
        LEFT JOIN sys_config AS d ON (d.id = a.order_type)
        LEFT JOIN sys_config AS e ON (e.id = a.priority)
        where a.status = 725

    </select>


    <!-- 查询已分配发货单 -->
    <select id="querySendGoods" parameterType="map" resultType="dto">
        SELECT
        z.id,
        z.order_no,
        c.`name` AS provider_owner_name,
        d.val AS order_type_name,
        e.val AS priority_name,
        z.create_time
        FROM
        w_out_batch_sale AS b
        LEFT JOIN w_order_sale AS z ON (z.id = b.order_id)
        LEFT JOIN w_cmn_provider AS c ON (z.provider_owner_id = c.id)
        LEFT JOIN sys_config AS d ON (d.id = z.order_type)
        LEFT JOIN sys_config AS e ON (e.id = z.priority)
        WHERE
        z.is_delete = 'N'
        <if test="null!=batch_id   and ''!= batch_id ">
            and b.batch_id=#{batch_id}
        </if>
        order by z.id desc
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <select id="querySendGoodsCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        FROM
        w_out_batch_sale AS b
        LEFT JOIN w_order_sale AS z ON (z.id = b.order_id)
        LEFT JOIN w_cmn_provider AS c ON (z.provider_owner_id = c.id)
        LEFT JOIN sys_config AS d ON (d.id = z.order_type)
        LEFT JOIN sys_config AS e ON (e.id = z.priority)
        where z.is_delete='N'
        <if test="null!=batch_id   and ''!= batch_id ">
            and b.batch_id=#{batch_id}
        </if>
        order by z.id desc
    </select>


    <update id="updateStatusInfo" parameterType="dto">
        update w_order_sale
        set
        <if test="null!=status">
            status = #{status},
        </if>
        <if test="null!=updator  and ''!= updator">
            updator = #{updator},
        </if>
        update_time = now()
        where id = #{id}
    </update>
</mapper>
