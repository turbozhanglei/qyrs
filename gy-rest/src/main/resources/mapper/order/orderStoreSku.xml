<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orderStoreSku">
    <sql id="sql_where">
        <if test="null!=number  and ''!= number">
            and a.number LIKE concat('%',#{number},'%')
        </if>
        <if test="null!=status">
            and a.status = #{status}
        </if>
        <if test="null!=order_id  and ''!= order_id">
            and a.order_id = #{order_id}
        </if>
        <if test="null!=providerName  and ''!= providerName">
            and wcp.name LIKE concat('%',#{providerName},'%')
        </if>
        <if test="null!=skuName  and ''!= skuName">
            and ws.name LIKE concat('%',#{skuName},'%')
        </if>
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
    </sql>


    <!-- 列表查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT a. *
        FROM (
        SELECT a.id,a.stock,a.sku_id,a.create_time,bs.ea_num,bs.`name` as
        skuname,bs.num,bs.trace_number,bs.measure_unit,
        bs.rough_weight,bs.net_weight,bs.volume,bs.worth,ws.`name` as settingname,w.`name` as warehousename,
        p.`name` as ownername,wf.`name` as facilityname,oa.order_no,p1.`name` as
        providername,TIMESTAMPDIFF(HOUR,a.create_time,now()) as times
        from w_order_store_sku a
        LEFT JOIN w_order_add_sku bs on a.order_id = bs.order_id
        LEFT JOIN w_order_add oa on bs.order_id = oa.id
        LEFT JOIN w_warehouse_site_setting ws ON ws.id = a.setting_id
        LEFT JOIN w_warehouse_facility_setting wf ON wf.id = bs.facility_id
        LEFT JOIN w_warehouse w ON ws.warehouse_id = w.id
        LEFT JOIN w_cmn_provider p ON a.provider_id = p.id
        LEFT JOIN w_cmn_provider p1 ON oa.provider_id = p1.id
        WHERE 1 = 1 AND a.is_delete = 'N' AND a.order_type = 0
        <if test="null!=ownername  and ''!= ownername">
            and p.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=warehousename  and ''!= warehousename">
            and w.name LIKE concat('%',#{warehousename},'%')
        </if>
        <if test="null!=skuname  and ''!= skuname">
            and bs.name LIKE concat('%',#{skuname},'%')
        </if>
        <if test="null!=startDate  and ''!= startDate">
            and DATE(a.create_time) &gt;= #{startDate}
        </if>
        <if test="null!=endDate  and ''!= endDate">
            and DATE(a.create_time) &lt;= #{endDate}
        </if>
        UNION ALL
        SELECT a.id,a.stock,a.sku_id,a.create_time,bs.ea_num,bs.`name` as
        skuname,bs.num,bs.trace_number,bs.measure_unit,
        bs.rough_weight,bs.net_weight,bs.volume,bs.worth,ws.`name` as settingname,w.`name` as warehousename,
        p.`name` as ownername,wf.`name` as facilityname,oa.order_no,p1.`name` as
        providername,TIMESTAMPDIFF(HOUR,a.create_time,now()) as times
        from w_order_store_sku a
        LEFT JOIN w_order_asn_sku bs on a.order_id = bs.order_id
        LEFT JOIN w_order_asn oa on bs.order_id = oa.id
        LEFT JOIN w_warehouse_site_setting ws ON ws.id = a.setting_id
        LEFT JOIN w_warehouse_facility_setting wf ON wf.id = bs.facility_id
        LEFT JOIN w_warehouse w ON ws.warehouse_id = w.id
        LEFT JOIN w_cmn_provider p ON a.provider_id = p.id
        LEFT JOIN w_cmn_provider p1 ON oa.provider_id = p1.id
        WHERE 1 = 1 AND a.is_delete = 'N' AND a.order_type = 1
        <if test="null!=ownername  and ''!= ownername">
            and p.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=warehousename  and ''!= warehousename">
            and w.name LIKE concat('%',#{warehousename},'%')
        </if>
        <if test="null!=skuname  and ''!= skuname">
            and bs.name LIKE concat('%',#{skuname},'%')
        </if>
        <if test="null!=startDate  and ''!= startDate">
            and DATE(a.create_time) &gt;= #{startDate}
        </if>
        <if test="null!=endDate  and ''!= endDate">
            and DATE(a.create_time) &lt;= #{endDate}
        </if>
        ) as a
        GROUP BY a.id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM (
        SELECT a.id,a.stock,a.sku_id,a.create_time,bs.ea_num,bs.`name` as
        skuname,bs.num,bs.trace_number,bs.measure_unit,
        bs.rough_weight,bs.net_weight,bs.volume,bs.worth,ws.`name` as settingname,w.`name` as warehousename,
        p.`name` as ownername,wf.`name` as facilityname,oa.order_no,p1.`name` as
        providername,TIMESTAMPDIFF(HOUR,a.create_time,now()) as times
        from w_order_store_sku a
        LEFT JOIN w_order_add_sku bs on a.order_id = bs.order_id
        LEFT JOIN w_order_add oa on bs.order_id = oa.id
        LEFT JOIN w_warehouse_site_setting ws ON ws.id = a.setting_id
        LEFT JOIN w_warehouse_facility_setting wf ON wf.id = bs.facility_id
        LEFT JOIN w_warehouse w ON ws.warehouse_id = w.id
        LEFT JOIN w_cmn_provider p ON a.provider_id = p.id
        LEFT JOIN w_cmn_provider p1 ON oa.provider_id = p1.id
        WHERE 1 = 1 AND a.is_delete = 'N' AND a.order_type = 0
        <if test="null!=ownername  and ''!= ownername">
            and p.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=warehousename  and ''!= warehousename">
            and w.name LIKE concat('%',#{warehousename},'%')
        </if>
        <if test="null!=skuname  and ''!= skuname">
            and bs.name LIKE concat('%',#{skuname},'%')
        </if>
        <if test="null!=startDate  and ''!= startDate">
            and DATE(a.create_time) &gt;= #{startDate}
        </if>
        <if test="null!=endDate  and ''!= endDate">
            and DATE(a.create_time) &lt;= #{endDate}
        </if>
        UNION ALL
        SELECT a.id,a.stock,a.sku_id,a.create_time,bs.ea_num,bs.`name` as
        skuname,bs.num,bs.trace_number,bs.measure_unit,
        bs.rough_weight,bs.net_weight,bs.volume,bs.worth,ws.`name` as settingname,w.`name` as warehousename,
        p.`name` as ownername,wf.`name` as facilityname,oa.order_no,p1.`name` as
        providername,TIMESTAMPDIFF(HOUR,a.create_time,now()) as times
        from w_order_store_sku a
        LEFT JOIN w_order_asn_sku bs on a.order_id = bs.order_id
        LEFT JOIN w_order_asn oa on bs.order_id = oa.id
        LEFT JOIN w_warehouse_site_setting ws ON ws.id = a.setting_id
        LEFT JOIN w_warehouse_facility_setting wf ON wf.id = bs.facility_id
        LEFT JOIN w_warehouse w ON ws.warehouse_id = w.id
        LEFT JOIN w_cmn_provider p ON a.provider_id = p.id
        LEFT JOIN w_cmn_provider p1 ON oa.provider_id = p1.id
        WHERE 1 = 1 AND a.is_delete = 'N' AND a.order_type = 1
        <if test="null!=ownername  and ''!= ownername">
            and p.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=warehousename  and ''!= warehousename">
            and w.name LIKE concat('%',#{warehousename},'%')
        </if>
        <if test="null!=skuname  and ''!= skuname">
            and bs.name LIKE concat('%',#{skuname},'%')
        </if>
        <if test="null!=startDate  and ''!= startDate">
            and DATE(a.create_time) &gt;= #{startDate}
        </if>
        <if test="null!=endDate  and ''!= endDate">
            and DATE(a.create_time) &lt;= #{endDate}
        </if>
        ) as a
        GROUP BY a.id
    </select>

    <!-- 插入 -->
    <insert id="saveInfo" parameterType="map">
        insert into w_order_store_sku (deptid, order_id,
        order_type, sku_id, stock,
        provider_id, setting_id, status,overcharge,owing,productstatus,
        create_time, creator, is_delete)
        values (#{deptid}, '2',
        #{order_type}, '12', #{stock},
        #{provider_id}, #{setting_id}, #{status},#{overcharge},#{owing},#{productstatus},
        now(), #{creator}, 'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 删除 -->
    <update id="deleteInfo" parameterType="map">
        UPDATE w_order_store_sku set is_delete = 'Y' where id = #{id}
    </update>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="map">
        UPDATE w_order_store_sku a
        set
        <if test="null!=deptid  and ''!= deptid">
            a.deptid = #{deptid},
        </if>
        <if test="null!=sku_id  and ''!= sku_id">
            a.sku_id = #{sku_id},
        </if>
        <if test="null!=stock  and ''!= stock">
            a.stock = #{stock},
        </if>
        <if test="null!=addstock  and ''!= addstock">
            a.lock_stock = a.lock_stock+#{addstock},
        </if>
        <if test="null!=substock  and ''!= substock">
            a.lock_stock = a.lock_stock-#{substock},
        </if>
        <if test="null!=provider_id  and ''!= provider_id">
            a.provider_id = #{provider_id},
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            a.setting_id = #{setting_id},
        </if>
        <if test="null!=status">
            a.status = #{status},
        </if>
        <if test="null!=overcharge  and ''!= overcharge">
            a.overcharge = #{overcharge},
        </if>
        <if test="null!=owing  and ''!= owing">
            a.owing = #{owing},
        </if>
        <if test="null!=productstatus  and ''!= productstatus">
            a.productstatus = #{productstatus},
        </if>
        <if test="null!=updator  and ''!= updator">
            a.updator = #{updator},
        </if>
        update_time = now()
        where a.id = #{id}
    </update>

    <!-- 对象查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT
        a.*
        FROM
        w_order_store_sku a
        <include refid="sql_where"/>
    </select>


    <select id="queryInventoryAdjustment" parameterType="map" resultType="dto">
        SELECT a.*
        FROM (
        SELECT a.id,a.stock,a.sku_id,bs.ea_num,bs.`name` as skuname,bs.num,bs.trace_number,bs.measure_unit,
        bs.rough_weight,bs.net_weight,bs.volume,bs.worth,bs.create_time,ws.`name` as settingname,w.`name` as
        warehousename,
        p.`name` as ownername,cp.`name` as providername,oa.order_no,wf.`name` as facilityname
        from w_order_store_sku a
        LEFT JOIN w_order_add_sku bs on a.order_id = bs.order_id AND a.order_type = 0
        LEFT JOIN w_order_add oa on bs.order_id = oa.id
        LEFT JOIN w_cmn_provider cp on oa.provider_id = cp.id
        LEFT JOIN w_warehouse_site_setting ws ON ws.id = a.setting_id
        LEFT JOIN w_warehouse_facility_setting wf ON wf.id = bs.facility_id
        LEFT JOIN w_warehouse w ON ws.warehouse_id = w.id
        LEFT JOIN w_cmn_provider p ON a.provider_id = p.id
        UNION ALL
        SELECT a.id,a.stock,a.sku_id,bs.ea_num,bs.`name` as skuname,bs.num,bs.trace_number,bs.measure_unit,
        bs.rough_weight,bs.net_weight,bs.volume,bs.worth,bs.create_time,ws.`name` as settingname,w.`name` as
        warehousename,
        p.`name` as ownername,cp.`name` as providername,oa.order_no,wf.`name` as facilityname
        from w_order_store_sku a
        LEFT JOIN w_order_asn_sku bs on a.order_id = bs.order_id AND a.order_type = 1
        LEFT JOIN w_order_asn oa on bs.order_id = oa.id
        LEFT JOIN w_cmn_provider cp on oa.provider_id = cp.id
        LEFT JOIN w_warehouse_site_setting ws ON ws.id = a.setting_id
        LEFT JOIN w_warehouse_facility_setting wf ON wf.id = bs.facility_id
        LEFT JOIN w_warehouse w ON ws.warehouse_id = w.id
        LEFT JOIN w_cmn_provider p ON a.provider_id = p.id) as a
        where 1=1
        <if test="null!=skuname  and ''!= skuname">
            and bs.name LIKE concat('%',#{skuname},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and cp.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=warehousename  and ''!= warehousename">
            and w.`name` LIKE concat('%',#{warehousename},'%')
        </if>
        GROUP BY a.id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>


    <!-- 列表数量查询 -->
    <select id="queryInventoryAdjustmentCount" parameterType="map" resultType="dto">
        SELECT
        count(1) as total
        from w_order_store_sku a
        LEFT JOIN w_order_add_sku bs on a.order_id = bs.order_id AND a.order_type = 0
        LEFT JOIN w_order_add oa on bs.order_id = oa.id
        LEFT JOIN w_cmn_provider cp on oa.provider_id = cp.id
        LEFT JOIN w_warehouse_site_setting ws ON ws.id = a.setting_id
        LEFT JOIN w_warehouse_facility_setting wf ON wf.id = bs.facility_id
        LEFT JOIN w_warehouse w ON ws.warehouse_id = w.id
        LEFT JOIN w_cmn_provider p ON a.provider_id = p.id
        WHERE 1 = 1
        <if test="null!=skuname  and ''!= skuname">
            and bs.name LIKE concat('%',#{skuname},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and cp.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=warehousename  and ''!= warehousename">
            and w.`name` LIKE concat('%',#{warehousename},'%')
        </if>
        AND a.is_delete = 'N'
    </select>

    <!-- 修改 -->
    <update id="updateStockInfo" parameterType="map">
        UPDATE w_order_store_sku a
        set
        <if test="null!=deptid  and ''!= deptid">
            a.deptid = #{deptid},
        </if>
        <if test="null!=sku_id  and ''!= sku_id">
            a.sku_id = #{sku_id},
        </if>
        <if test="null!=stock  and ''!= stock">
            a.stock = #{stock},
        </if>
        <if test="null!=addstock  and ''!= addstock">
            a.lock_stock = a.lock_stock+#{addstock},
        </if>
        <if test="null!=substock  and ''!= substock">
            a.lock_stock = a.lock_stock-#{substock},
        </if>
        <if test="null!=provider_id  and ''!= provider_id">
            a.provider_id = #{provider_id},
        </if>
        <if test="null!=setting_id  and ''!= setting_id">
            a.setting_id = #{setting_id},
        </if>
        <if test="null!=status">
            a.status = #{status},
        </if>
        <if test="null!=updator  and ''!= updator">
            a.updator = #{updator},
        </if>
        update_time = now()
        where a.sku_id = #{sku_id}
    </update>

    <!--查询库里列表-->
    <select id="queryStockByDeptId" parameterType="map" resultType="dto">
        SELECT
        ifnull(b.`name`,'') as name,
        ifnull(a.stock,0) as stock,
        ifnull(a.lock_stock,0) as lock_stock,
        b.sku_id,
        ifnull(b.num,'') as num,
        ifnull(c.`name`,'') as provider_name,
        ifnull(d.`name`,'') as setting_name,
        ifnull(e.`name`,'') as facility_name
        FROM
        w_order_store_sku AS a
        LEFT JOIN w_order_asn_sku AS b ON (a.sku_id = b.sku_id)
        LEFT JOIN w_cmn_provider AS c ON (a.provider_id = c.id)
        LEFT JOIN w_warehouse_site_setting AS d ON (b.setting_id = d.id)
        LEFT JOIN w_warehouse_facility_setting AS e ON (b.facility_id = e.id)
        where 1=1
        <if test="null!=deptid   and ''!= deptid ">
            and a.deptid=#{deptid}
        </if>
        <if test="null!=sku_id   and ''!= sku_id ">
            and a.sku_id=#{sku_id}
        </if>
    </select>

    <!--上下架更新-->
    <update id="updateDownUpperStatus" parameterType="map">
        UPDATE w_order_asn_sku AS a,
        w_order_store_sku AS b
        SET a. STATUS = #{status},
        b. STATUS = #{status}
        WHERE a.sku_id=#{sku_id}
        and b.sku_id=#{sku_id}
    </update>

    <!-- 删除 -->
    <update id="updateStatus" parameterType="map">
        UPDATE w_order_store_sku a
        SET a.STATUS = 1,
        update_time = now()
        WHERE a.status=0
        and
        a.in_batch_number = #{in_batch_number}
        ORDER BY
        a.id
        LIMIT ${out_stock_num}

    </update>

    <!-- 列表查询 -->
    <select id="queryByOutStockNum" parameterType="map" resultType="dto">
        SELECT
        a.*
        FROM
        w_order_store_sku a
        WHERE
        a.sku_id =#{sku_id}
        AND a.in_batch_number =#{in_batch_number}
        AND a.provider_id =#{provider_id}
        AND a.status = 0
        ORDER BY
        a.create_time
        <if test="null!=out_stock_num  and ''!= out_stock_num">
            limit ${out_stock_num}
        </if>

    </select>
</mapper>
