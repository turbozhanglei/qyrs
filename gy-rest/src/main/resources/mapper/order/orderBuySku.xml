<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->
<!-- 参数管理手工映射SQL语句 -->
<mapper namespace="orderBuySku">


    <sql id="sql_where">
        <if test="null!=number  and ''!= number">
            and a.number LIKE concat('%',#{number},'%')
        </if>
        <if test="null!=transfer_store  and ''!= transfer_store">
            and a.transfer_store LIKE concat('%',#{transfer_store},'%')
        </if>
        <if test="null!=status">
            and a.status = #{status}
        </if>
        <if test="null!=order_id  and ''!= order_id">
            and a.order_id = #{order_id}
        </if>
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
        <if test="null!=is_transfer ">
            and a.is_transfer = #{is_transfer}
        </if>
    </sql>

    <!-- 查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT 	a.*, s.val AS statusval,b.storage_temp,b.number as sku_number
        FROM w_order_buy_sku a
        LEFT JOIN sys_config s on a.status = s.id
        LEFT JOIN w_sku b on a.sku_id = b.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER BY id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_buy_sku a
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
    </select>

    <!-- 查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT
        a.*,
        b.number as sku_number,
        b.unit_volume,
        b.unit_weight,
        b.type_id,
        c.food_add_type,
        c.number as type_number,
        c.text,
        d.bill,
        d.bill_photo,
        d.customer_id,
        d.status as order_buy_status,
        GROUP_CONCAT(e.driver_id) as driver_id_list
        FROM
        w_order_buy_sku a
        LEFT JOIN w_sku b ON a.sku_id = b.id AND b.is_delete = 'N'
        LEFT JOIN w_sku_type c ON b.type_id = c.id AND c.is_delete = 'N'
        LEFT JOIN w_order_buy d on a.order_id = d.id
        LEFT JOIN w_order_buy_sku_driver e on a.id = e.buy_sku_id and e.is_delete = 'N'
        WHERE a.is_delete = 'N'
        <include refid="sql_where"/>
        GROUP BY a.id
        limit 0,1
    </select>


    <!-- 查询 -->
    <select id="getList" parameterType="map" resultType="dto">
        SELECT
        a.*,
        b.number as sku_number,
        b.unit_volume,
        b.unit_weight,
        b.type_id,
        c.food_add_type,
        c.number as type_number,
        c.text,
        d.bill,
        d.bill_photo,
        d.customer_id,
        d.status as order_buy_status,
        GROUP_CONCAT(e.driver_id) as driver_id_list
        FROM
        w_order_buy_sku a
        LEFT JOIN w_sku b ON a.sku_id = b.id AND b.is_delete = 'N'
        LEFT JOIN w_sku_type c ON b.type_id = c.id AND c.is_delete = 'N'
        LEFT JOIN w_order_buy d on a.order_id = d.id
        LEFT JOIN w_order_buy_sku_driver e on a.id = e.buy_sku_id and e.is_delete = 'N'
        WHERE a.is_delete = 'N'
        <include refid="sql_where"/>
        GROUP BY a.id
    </select>


    <!-- 插入 -->
    <insert id="saveInfo" parameterType="dto">
        INSERT INTO `w_order_buy_sku` (
        <if test="transfer_store!=null and ''!=transfer_store">
            transfer_store,
        </if>
        <if test="transfer_store_address!=null and ''!=transfer_store_address">
            transfer_store_address,
        </if>
        <if test="transfer_people!=null and ''!=transfer_people">
            transfer_people,
        </if>
        <if test="transfer_people_mobile!=null and ''!=transfer_people_mobile">
            transfer_people_mobile,
        </if>
        <if test="transfer_expect_time!=null and ''!=transfer_expect_time">
            transfer_expect_time,
        </if>
        <if test="transfer_end_time!=null and ''!=transfer_end_time">
            transfer_end_time,
        </if>
        <if test="is_transfer!=null">
            is_transfer,
        </if>
        `number`, `name`, `order_id`, `sku_id`, `level`,`num`, `roduction_date`,
        `expiration_date`, `package`, `measure_unit`, `ea_num`, `rough_weight`, `net_weight`, `volume`, `worth`,
        `trace_number`, `status`, `remark`,shelflife, `create_time`, `creator`, `update_time`, `updator`, `is_delete`)
        VALUES
        (
        <if test="transfer_store!=null and ''!=transfer_store">
            #{transfer_store},
        </if>
        <if test="transfer_store_address!=null and ''!=transfer_store_address">
            #{transfer_store_address},
        </if>
        <if test="transfer_people!=null and ''!=transfer_people">
            #{transfer_people},
        </if>
        <if test="transfer_people_mobile!=null and ''!=transfer_people_mobile">
            #{transfer_people_mobile},
        </if>
        <if test="transfer_expect_time!=null and ''!=transfer_expect_time">
            #{transfer_expect_time},
        </if>
        <if test="transfer_end_time!=null and ''!=transfer_end_time">
            #{transfer_end_time},
        </if>
        <if test="is_transfer!=null ">
            #{is_transfer},
        </if>
        #{number}, #{name}, #{order_id}, #{sku_id}, #{level}, #{num}, #{roduction_date}, #{expiration_date},
        #{package},
        #{measure_unit}, #{ea_num}, #{rough_weight}, #{net_weight}, #{volume}, #{worth}, #{trace_number},0,
        #{remark},#{shelflife}, NOW(), #{creator},NOW(), #{updator}, 'N')
        <selectKey resultType="java.lang.Long" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="dto">
        UPDATE `w_order_buy_sku`
        SET
        <if test="null!=number  and ''!= number">number=#{number} ,</if>
        <if test="null!=name  and ''!= name">name=#{name} ,</if>
        <if test="null!=order_id  and ''!= order_id">order_id=#{order_id} ,</if>
        <if test="null!=sku_id  and ''!= sku_id">sku_id=#{sku_id} ,</if>
        <if test="null!=num  and ''!= num">num=#{num} ,</if>
        <if test="null!=roduction_date  and ''!= roduction_date">roduction_date=#{roduction_date} ,</if>
        <if test="null!=expiration_date  and ''!= expiration_date">expiration_date=#{expiration_date} ,</if>
        <if test="null!=package  and ''!= package">package=#{package} ,</if>
        <if test="null!=measure_unit  and ''!= measure_unit">measure_unit=#{measure_unit} ,</if>
        <if test="null!=ea_num  and ''!= ea_num">ea_num=#{ea_num} ,</if>
        <if test="null!=rough_weight  and ''!= rough_weight">rough_weight=#{rough_weight} ,</if>
        <if test="null!=net_weight  and ''!= net_weight">net_weight=#{net_weight} ,</if>
        <if test="null!=volume  and ''!= volume">volume=#{volume} ,</if>
        <if test="null!=worth  and ''!= worth">worth=#{worth} ,</if>
        <if test="null!=trace_number  and ''!= trace_number">trace_number=#{trace_number} ,</if>
        <if test="null!=status">status=#{status} ,</if>
        <if test="null!=remark  and ''!= remark">remark=#{remark} ,</if>
        <if test="null!=shelflife  and ''!= shelflife">shelflife=#{shelflife} ,</if>
        <if test="null!=create_time  and ''!= create_time">create_time=#{create_time} ,</if>
        <if test="null!=creator  and ''!= creator">creator=#{creator} ,</if>
        <if test="null!=update_time  and ''!= update_time">update_time=#{update_time} ,</if>
        <if test="null!=updator  and ''!= updator">updator=#{updator} ,</if>
        <if test="null!=is_delete  and ''!= is_delete">is_delete=#{is_delete} ,</if>
        <if test="null!=level  and ''!= level">level=#{level} ,</if>

        <if test="transfer_store!=null and ''!=transfer_store">transfer_store=#{transfer_store},</if>
        <if test="transfer_store_address!=null and ''!=transfer_store_address">transfer_store_address=#{transfer_store_address},</if>
        <if test="transfer_people!=null and ''!=transfer_people">transfer_people=#{transfer_people},</if>
        <if test="transfer_people_mobile!=null and ''!=transfer_people_mobile">transfer_people_mobile=#{transfer_people_mobile},</if>
        <if test="transfer_expect_time!=null and ''!=transfer_expect_time">transfer_expect_time=#{transfer_expect_time},</if>
        <if test="transfer_end_time!=null and ''!=transfer_end_time">transfer_end_time=#{transfer_end_time},</if>
        <if test="is_transfer!=null">is_transfer=#{is_transfer},</if>
        update_time = now()
        where id = #{id}
    </update>

    <!-- 删除 -->
    <delete id="deleteInfo" parameterType="map">
        UPDATE w_order_buy set is_delete = 'Y' WHERE id = #{id}
    </delete>

    <select id="orderBuySkuReport" parameterType="map" resultType="dto">
        SELECT a.id,a.order_no,a.end_time,a.purchase,a.receive,a.remark,
        GROUP_CONCAT(sk.`name`,',') as skuname,c.`name` as ownername,
        c1.`name` as providername,s.val AS priorityval,GROUP_CONCAT(oa.trace_number,',') as trace_number
        FROM w_order_buy a
        LEFT JOIN w_order_buy_sku oa on a.id = oa.order_id
        LEFT JOIN w_sku sk on sk.id = oa.sku_id
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_id = c1.id
        LEFT JOIN sys_config s on a.priority = s.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=ownername  and ''!= ownername">
            and c.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and c1.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=priority  and ''!= priority">
            and a.priority = #{priority}
        </if>
        GROUP BY a.id
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>


    <select id="orderBuySkuReportCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_buy a
        LEFT JOIN w_order_buy_sku oa on a.id = oa.order_id
        LEFT JOIN w_sku sk on sk.id = oa.sku_id
        LEFT JOIN w_cmn_provider c ON a.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON a.provider_id = c1.id
        LEFT JOIN sys_config s on a.priority = s.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=ownername  and ''!= ownername">
            and c.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and c1.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=priority  and ''!= priority">
            and a.priority = #{priority}
        </if>
        GROUP BY a.id
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>


    <select id="dayBuySkuReport" parameterType="map" resultType="dto">
        SELECT a.*,o.order_no,o.end_time,o.purchase,o.receive,o.remark,
        sk.`name` as skuname,c.`name` as ownername,
        c1.`name` as providername,s.val AS priorityval
        FROM w_order_buy_sku a
        LEFT JOIN w_order_buy o on o.id = a.order_id
        LEFT JOIN w_sku sk on sk.id = a.sku_id
        LEFT JOIN w_cmn_provider c ON o.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON o.provider_id = c1.id
        LEFT JOIN sys_config s on o.priority = s.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=ownername  and ''!= ownername">
            and c.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and c1.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=skuname  and ''!= skuname">
            and sk.name LIKE concat('%',#{skuname},'%')
        </if>
        ORDER BY a.id
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>


    <select id="dayBuySkuReportCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_buy_sku a
        LEFT JOIN w_order_buy o on o.id = a.order_id
        LEFT JOIN w_sku sk on sk.id = a.sku_id
        LEFT JOIN w_cmn_provider c ON o.provider_owner_id = c.id
        LEFT JOIN w_cmn_provider c1 ON o.provider_id = c1.id
        LEFT JOIN sys_config s on o.priority = s.id
        WHERE 1 = 1 AND a.is_delete = 'N'
        <if test="null!=order_no  and ''!= order_no">
            and a.order_no LIKE concat('%',#{order_no},'%')
        </if>
        <if test="null!=ownername  and ''!= ownername">
            and c.name LIKE concat('%',#{ownername},'%')
        </if>
        <if test="null!=providername  and ''!= providername">
            and c1.name LIKE concat('%',#{providername},'%')
        </if>
        <if test="null!=skuname  and ''!= skuname">
            and sk.name LIKE concat('%',#{skuname},'%')
        </if>
        ORDER BY a.id
        <if test="null!=start">
            limit ${start},${end}
        </if>
    </select>


    <!-- 插入 -->
    <insert id="saveOrderBuySkuDriver" parameterType="dto">
        INSERT INTO `w_order_buy_sku_driver` ( `buy_sku_id`, `driver_id`, `create_time`, `creator`, `is_delete`)
        VALUES
        ( #{buy_sku_id}, #{driver_id}, NOW(), #{creator}, 'N')
        <selectKey resultType="java.lang.Long" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>


    <!-- 插入 -->
    <insert id="saveInStockSkuDriver" parameterType="dto">
        INSERT INTO `w_in_stock_sku_driver` ( `buy_checked_id`, `driver_id`, `create_time`, `creator`,
        `is_delete`,`num`)
        VALUES
        ( #{buy_checked_id}, #{driver_id}, NOW(), #{creator}, 'N',#{num})
        <selectKey resultType="java.lang.Long" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>


    <!-- 删除 -->
    <delete id="deleteOrderBuySkuDriver" parameterType="map">
        DELETE FROM w_order_buy_sku_driver WHERE buy_sku_id = #{buy_sku_id}
    </delete>

    <!-- 删除 -->
    <delete id="deleteOrderBuySku" parameterType="map">
        update w_order_buy_sku set is_delete="Y" WHERE id= #{id}
    </delete>


    <update id="updateOrderBuySkuStatus" parameterType="map">
        update w_order_buy_sku set `status` = 2 , updator = #{updator} WHERE order_id= #{order_id} AND `status` in (0,1)
    </update>
    <update id="updateOrderBuyCheckedStatus" parameterType="map">
        update w_order_buy_checked set `status` = 1, updator = #{updator} WHERE order_id= #{order_id} AND `status` = 0
    </update>
</mapper>
