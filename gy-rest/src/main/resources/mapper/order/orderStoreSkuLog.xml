<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->

<!-- 参数管理手工映射SQL语句 -->
<!-- 库存 -->
<mapper namespace="orderStoreSkuLog">


    <sql id="sql_where">
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
        <if test="null!=in_batch_number  and ''!= in_batch_number">
            and a.in_batch_number = #{in_batch_number}
        </if>
    </sql>


    <!-- 列表查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT
        a.*, b.username,
        DATE_FORMAT(a.create_time, "%Y-%m-%d") AS timeline
        FROM
        w_order_store_sku_log a
        LEFT JOIN sys_user b ON a.creator = b.id
        WHERE
        1 = 1
        AND a.is_delete = 'N'
        <include refid="sql_where"/>
        ORDER BY
        a.id DESC
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_order_store_sku_log a
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
    </select>

    <!-- 插入 -->
    <insert id="saveInfo" parameterType="dto">
        insert into w_order_store_sku_log ( sku_id,
        log_type, remark, create_time,
        creator, is_delete,in_batch_number)
        values ( #{sku_id},
        #{log_type}, #{remark}, now(),
        #{creator}, 'N',#{in_batch_number})
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 删除 -->
    <update id="deleteInfo" parameterType="map">
        UPDATE w_order_store_sku_log set is_delete = 'Y' where id = #{id}
    </update>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="map">
        UPDATE w_order_store_sku_log a
        set
        <if test="null!=store_id  and ''!= store_id">
            a.store_id = #{store_id},
        </if>
        <if test="null!=sku_id  and ''!= sku_id">
            sku_id = #{sku_id},
        </if>
        <if test="null!=log_type  and ''!= log_type">
            log_type = #{log_type},
        </if>
        <if test="null!=remark  and ''!= remark">
            remark = #{remark},
        </if>
        <if test="null!=updator  and ''!= updator">
            a.updator = #{updator},
        </if>
        update_time = now()
        where a.id = #{id}
    </update>

    <!-- 对象查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT a.*
        FROM w_order_store_sku_log a
        WHERE 1 = 1 AND a.is_delete = 'N'
        <include refid="sql_where"/>
    </select>

    <!-- 对象查询 -->
    <select id="getMoveInventorycheck" parameterType="map" resultType="dto">
        SELECT
        a.*,c.*,b.number as tray_number
        FROM
        (
        SELECT
        a.in_batch_number,
        b.tray_id,
        b.setting_id
        FROM
        w_order_store_sku_log a
        LEFT JOIN w_order_store_sku b ON a.in_batch_number = b.in_batch_number
        WHERE TO_DAYS(NOW()) = TO_DAYS(a.create_time)
        GROUP BY
        b.tray_id
        ) a
        LEFT JOIN w_tray b ON a.tray_id = b.id
        LEFT JOIN (
        SELECT
        a.id,
        a.`name` AS set_name,
        a.number AS set_number,
        a.warehouse_area_id,
        a.warehouse_id,
        b.`name` AS area_name,
        b.number AS area_number,
        c.`name` AS house_name,
        c.number AS house_number
        FROM
        w_warehouse_site_setting a
        LEFT JOIN w_warehouse_area b ON a.warehouse_area_id = b.id
        LEFT JOIN w_warehouse c ON a.warehouse_id = c.id
        ) c ON c.id = a.setting_id
        WHERE
        1 = 1
        <if test="null!=tray_number  and ''!= tray_number">
            and b.number LIKE concatc('%',#{tray_number},'%')
        </if>
        ORDER BY c.warehouse_id,c.warehouse_area_id,c.id
    </select>
</mapper>
