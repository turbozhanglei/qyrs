<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- 参数管理手工映射SQL语句 -->

<!-- 参数管理手工映射SQL语句 -->
<!-- ASN表商品关联表 -->
<mapper namespace="package">

    <sql id="sql_where">
        <if test="null!=id  and ''!= id">
            and a.id = #{id}
        </if>
        <if test="null!=status">
            and a.status = #{status}
        </if>
    </sql>


    <!-- 列表查询 -->
    <select id="queryList" parameterType="map" resultType="dto">
        SELECT
        *,b.val as package_type_name
        FROM
        w_package AS a
        LEFT JOIN sys_config as b on(a.package_type=b.id)
        where a.is_delete='N'
        <include refid="sql_where"/>
        ORDER by a.id
        <if test="null!=start">
            limit #{start},#{end}
        </if>
    </select>

    <!-- 列表数量查询 -->
    <select id="queryListCount" parameterType="map" resultType="dto">
        SELECT count(1) as total
        FROM w_package a
        where a.is_delete='N'
        <include refid="sql_where"/>
        ORDER by a.id
    </select>

    <!-- 对象查询 -->
    <select id="getInfo" parameterType="map" resultType="dto">
        SELECT a.*
        FROM w_package a
        <include refid="sql_where"/>
    </select>

    <!-- 插入 -->
    <insert id="saveInfo" parameterType="map">
        insert into w_package
        (
        package_no,
        package_name,
        package_type,
        remark,
        create_time,
        creator,
        is_delete
        )
        values (#{package_no}, #{package_name},
        #{package_type}, #{remark}, now(),
        #{creator}, 'N')
        <selectKey resultType="java.lang.String" keyProperty="id">
            SELECT LAST_INSERT_ID() as id
        </selectKey>
    </insert>

    <!-- 删除 -->
    <update id="deleteInfo" parameterType="map">
        UPDATE w_package set is_delete = 'Y' where id = #{id}
    </update>

    <!-- 修改 -->
    <update id="updateInfo" parameterType="map">
        UPDATE w_package
        set
        <if test="null!=package_no  and ''!= package_no">
            package_no = #{package_no},
        </if>
        <if test="null!=package_name  and ''!= package_name">
            package_name = #{package_name},
        </if>
        <if test="null!=package_type  and ''!= package_type">
            package_type = #{package_type},
        </if>
        <if test="null!=status">
            status = #{status},
        </if>
        <if test="null!=remark  and ''!= remark">
            remark = #{remark},
        </if>
        <if test="null!=updator  and ''!= updator">
            updator = #{updator},
        </if>
        update_time = now()
        where id = #{id}
    </update>


    <update id="updatePackingInfo" parameterType="map">
        UPDATE w_package
        set
        <if test="null!=status">
            status = #{status},
        </if>
        update_time = now()
        where id = #{id}
    </update>


    <update id="updatePackStatus" parameterType="map">
        UPDATE w_order_sale
        SET STATUS = 730
        WHERE
        id IN (
        SELECT t.id
        FROM
        (SELECT
        f.id
        FROM
        w_package p
        LEFT JOIN w_package_pick a on p.id = a.package_id
        LEFT JOIN w_picking_sku AS b ON (a.picking_id = b.picking_id)
        LEFT JOIN w_batch_allot AS c ON (b.allot_id = c.id)
        LEFT JOIN w_order_sale AS f ON (c.sale_order_id = f.id)
        WHERE p.id = #{id}) as t
        )
    </update>

    <!--更新改打包商品下的订单节点信息-->
    <update id="updateSaleByPackageId" parameterType="map">
        UPDATE w_order_sale
        SET STATUS = #{status}
        WHERE
        id IN (
        SELECT
        a.id
        FROM
        (
        SELECT
        f.id
        FROM
        w_picking_sku AS e
        left join w_batch_allot AS c on(c.id=e.allot_id)
        LEFT JOIN w_order_sale AS f ON (c.sale_order_id = f.id)
        WHERE
        e.picking_id = #{id}
        )as a

        )
    </update>
</mapper>
